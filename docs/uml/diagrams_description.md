# Полное описание UML диаграмм Hockey Editor Pro

## Введение

Данный документ содержит подробное описание полного комплекта UML диаграмм для приложения Hockey Editor Pro - профессионального инструмента анализа хоккейных матчей. Комплект состоит из 8 диаграмм, каждая из которых раскрывает определенный аспект архитектуры и функциональности системы.

Диаграммы разработаны в соответствии с принципами объектно-ориентированного анализа и проектирования, следуют стандартам ГОСТ и UML 2.x. Все диаграммы созданы в формате PlantUML для обеспечения версионности и portability.

## 1. Диаграмма вариантов использования (Use Case Diagram)

**Файл:** `use_case_diagram.puml`  
**Назначение:** Определяет функциональные требования системы с точки зрения пользователя

### Основные элементы:

#### Актеры:
- **Hockey Coach/Analyst** - основной пользователь системы, тренер или аналитик хоккейной команды

#### Варианты использования:

**Основные функциональные сценарии:**
- **Load Video** - загрузка видеофайла матча
- **Mark Attack Events** - разметка атакующих действий (горячая клавиша A)
- **Mark Defense Events** - разметка оборонительных действий (горячая клавиша D)
- **Mark Shift Events** - разметка смен составов (горячая клавиша S)
- **Review Timeline** - просмотр интерактивной временной шкалы
- **Edit Segments** - редактирование размеченных сегментов
- **Preview Segments** - предварительный просмотр сегментов
- **Export Segments** - экспорт сегментов в различные форматы

**Вспомогательные функции:**
- **Save/Load Project** - сохранение и загрузка проектов
- **Configure Settings** - настройка параметров приложения
- **Customize Hotkeys** - настройка горячих клавиш
- **Undo/Redo Actions** - отмена и повтор операций

### Связи и зависимости:

**Отношения включения (<<include>>):**
- Все сценарии разметки включают загрузку видео
- Редактирование и предварительный просмотр включают просмотр timeline
- Экспорт включает просмотр timeline

**Отношения расширения (<<extend>>):**
- Настройка горячих клавиш расширяет базовые настройки
- Undo/Redo расширяют операции разметки

### Ключевые бизнес-процессы:

**Workflow разметки событий:**
1. Пользователь загружает видео
2. Во время просмотра нажимает горячую клавишу (A/D/S)
3. Система начинает запись сегмента
4. Повторное нажатие завершает сегмент
5. Сегмент появляется на timeline

**Особенности timeline:**
- 3 цветовые дорожки для разных типов событий
- Поддержка масштабирования и панорамирования
- Интерактивные сегменты с возможностью drag/resize
- Двойной клик открывает диалог редактирования

## 2. Контекстная диаграмма классов (Context Class Diagram)

**Файл:** `context_class_diagram.puml`  
**Назначение:** Показывает высокоуровневую архитектуру системы и основные компоненты

### Основные классы:

#### Ядро системы:
- **MainWindow** - главный интерфейс пользователя, точка входа в приложение
- **VideoController** - центральный контроллер, управляющий всем процессом видеоанализа
- **VideoProcessor** - обработчик видеофайлов, работа с OpenCV
- **ProjectManager** - менеджер проектов, сохранение/загрузка .hep файлов
- **Marker** - модель данных события (сегмента видео)

#### Система управления:
- **SettingsManager** - управление настройками и горячими клавишами
- **UndoRedoManager** - система отмены/повтора операций
- **CustomEventManager** - управление пользовательскими типами событий

### Архитектурные связи:

**Основные взаимодействия:**
- MainWindow контролирует VideoController
- VideoController использует все остальные компоненты
- VideoController создает и управляет Markers
- ProjectManager и UndoRedoManager работают с Markers

### Принципы разделения ответственности:

**VideoController как центральный хаб:**
- Координирует работу всех подсистем
- Управляет состоянием приложения
- Синхронизирует UI и бизнес-логику

**Внешние зависимости:**
- SettingsManager использует QSettings для персистентности
- VideoProcessor зависит от OpenCV для видеообработки
- ProjectManager работает с файловой системой

## 3. Детальная диаграмма классов (Class Diagram)

**Файл:** `class_diagram.puml`  
**Назначение:** Подробное описание всех классов системы с атрибутами, методами и связями

### Архитектурные слои:

#### Core Components (Бизнес-логика):
- **VideoController** - центральный контроллер с полным API
- **VideoProcessor** - низкоуровневая работа с видео через OpenCV
- **EventCreationController** - управление процессом создания событий
- **ProjectManager** - сериализация проектов в ZIP-формат
- **Exporter** - экспорт сегментов с кодированием

#### UI Components (Пользовательский интерфейс):
- **MainWindow** - главное окно с меню и горячими клавишами
- **TimelineGraphicsView** - интерактивная временная шкала на QGraphicsView
- **PreviewWindow** - окно предварительного просмотра сегментов
- **EditSegmentDialog** - диалог редактирования сегментов
- **ExportDialog** - диалог экспорта с прогресс-баром

#### Models (Модели данных):
- **Marker** - базовая модель сегмента с временными рамками
- **EventType** - перечисление типов событий (ATTACK, DEFENSE, SHIFT)

#### Utils (Утилиты):
- **SettingsManager** - QSettings-обертка для настроек
- **ShortcutManager** - динамическое управление горячими клавишами
- **UndoRedoManager** - QUndoStack для отмены операций
- **AutosaveManager** - автоматическое сохранение с восстановлением

### Ключевые отношения:

**Зависимости по слоям:**
- UI зависит от Core для бизнес-логики
- Core использует Models для данных
- Utils предоставляют сервисы всем слоям

**Qt-specific паттерны:**
- Signals/Slots для асинхронной коммуникации
- QUndoCommand для отменяемых операций
- QTimer для автоматического сохранения

### Особенности реализации:

**VideoController как фасад:**
- Единая точка входа для всех операций
- Управление состоянием воспроизведения
- Координация между UI и ядром

**TimelineGraphicsView:**
- QGraphicsScene для эффективного рендеринга
- Поддержка масштабирования и навигации
- Интерактивные элементы с drag/resize

## 4. Диаграмма состояний (State Machine Diagram)

**Файл:** `extended_state_machine_diagram.puml`  
**Назначение:** Моделирование состояний объектов Marker и процесса воспроизведения видео

### Две параллельные машины состояний:

#### Video Playback States (Состояния воспроизведения видео):

**Основные состояния:**
- **Stopped** - видео загружено но не воспроизводится
- **Playing** - активное автоматическое воспроизведение
- **Paused** - воспроизведение на паузе
- **Frame-by-frame** - покадровое перемещение

**Переходы:**
- Stopped ↔ Playing (play/pause/stop)
- Playing ↔ Paused (pause)
- Paused ↔ Frame-by-frame (стрелки влево/вправо)

#### Marker Lifecycle States (Жизненный цикл маркера):

**Состояния:**
- **Created** - объект создан, но не отображен
- **Visible** - маркер виден на timeline
- **Selected** - маркер выделен для операций
- **Edited** - маркер редактируется
- **Deleted** - маркер удален (можно восстановить)

**Переходы:**
- Created → Visible (добавление в коллекцию)
- Visible ↔ Selected (выбор/снятие выделения)
- Selected → Edited (инициация редактирования)
- Edited → Visible/Selected (сохранение/отмена)
- Visible → Deleted (удаление)

### Координация между машинами:

**Взаимосвязи:**
- Во всех состояниях воспроизведения можно создавать маркеры
- Состояние воспроизведения влияет на доступные операции с маркерами
- Маркеры могут создаваться только при активном видео

### Детали состояний:

**Playing state:**
- QTimer активен с интервалом frame_time_ms
- Автоматическое продвижение кадров
- Возможность создания маркеров на лету

**Paused state:**
- QTimer остановлен
- Возможность точного позиционирования
- Редактирование существующих маркеров

**Selected state:**
- Визуальное выделение (цвет, handles)
- Доступны операции редактирования
- Активны контекстные меню

## 5. Диаграмма деятельности (Activity Diagram)

**Файл:** `activity_diagram.puml`  
**Назначение:** Моделирование бизнес-процесса разметки событий во время просмотра матча

### Основной workflow:

#### Инициация процесса:
- Пользователь просматривает видео в режиме Playing
- Система ожидает нажатия горячих клавиш

#### Обработка горячих клавиш:
**Определение типа события:**
- По клавише определяется тип (A/D/S или пользовательский)
- Получение текущего кадра через get_current_frame_idx()

**Два режима работы:**

**Dynamic Mode (Динамический):**
- Первое нажатие: начало записи
- Второе нажатие: завершение с созданием маркера
- Поддержка pre-roll (откат перед началом)

**Fixed Length Mode (Фиксированная длина):**
- Одно нажатие создает сегмент фиксированной длины
- Автоматическое вычисление границ с учетом pre/post roll

#### Создание маркера:
- Инстанцирование объекта Marker
- Добавление в коллекцию markers[]
- Автоматический seek к началу сегмента
- Отправка сигналов обновления UI

#### Система сигналов:
- markers_changed.emit() - обновление списка маркеров
- recording_status_changed.emit() - статус процесса записи
- timeline_update.emit() - перерисовка timeline
- frame_ready.emit() - новый кадр для отображения

### Управление Undo/Redo:
- Каждая операция сохраняется в стек команд
- AddMarkerCommand для новых маркеров
- Поддержка многоуровневой отмены

### Условия завершения:
- Конец видео: остановка воспроизведения
- Пользовательское прерывание: pause/stop
- Циклическое продолжение процесса

## 6. Диаграмма пакетов (Package Diagram)

**Файл:** `package_diagram.puml`  
**Назначение:** Архитектурное представление 4-слойной структуры приложения

### Архитектурные слои:

#### Presentation Layer (Уровень презентации):
**ui package:**
- MainWindow, TimelineGraphicsView, PreviewWindow
- EditSegmentDialog, ExportDialog, SettingsDialog
- VideoWindow - компоненты пользовательского интерфейса

**assets package:**
- Icons, Stylesheets, UI Resources - статические ресурсы

#### Application Logic Layer (Уровень прикладной логики):
**core package:**
- VideoController, EventCreationController, ProjectManager
- Exporter, VideoProcessor, VideoReaderThread - бизнес-логика

**utils package:**
- ShortcutManager, UndoRedoManager, AutosaveManager
- SettingsManager, TimeUtils, CustomEvents - сквозная функциональность

#### Domain Logic Layer (Уровень доменной логики):
**models package:**
- Marker, EventType, Project, RecordingMode
- CustomEvent - бизнес-сущности и правила

#### Data Model Layer (Уровень модели данных):
**Persistence:**
- Project File (.hep), Settings Storage
- Recent Projects, Autosave Recovery - хранение данных

**External Data:**
- Video Files, Export Formats, Configuration Files - внешние данные

### Принципы разделения ответственности:

**Presentation Layer:**
- Обработка пользовательского ввода
- Визуализация данных
- Управление UI состоянием

**Application Logic Layer:**
- Оркестрация бизнес-процессов
- Интеграция с внешними системами
- Управление сквозными задачами

**Domain Logic Layer:**
- Бизнес-правила и валидации
- Поведение доменных объектов
- Определение бизнес-событий

**Data Model Layer:**
- Персистентность данных
- Работа с файловой системой
- Сериализация/десериализация

### Архитектурные принципы:

**Dependency Direction:**
- Зависимости направлены сверху вниз
- Высшие слои зависят от низших через абстракции
- Инверсия зависимостей для тестируемости

**Cross-cutting Concerns:**
- Undo/Redo, Settings, Autosave пронизывают все слои
- Логирование и обработка ошибок

## 7. Диаграммы компонентов и развертывания

**Файлы:** `component_diagram.puml`, `deployment_diagram.puml`  
**Назначение:** Техническая архитектура и развертывание системы

### Диаграмма компонентов:

#### Внутренние компоненты:
**Core:** VideoController, VideoProcessor, EventCreationController, ProjectManager, Exporter
**UI:** MainWindow, TimelineGraphicsView, PreviewWindow, EditSegmentDialog, ExportDialog
**Models:** Marker, EventType
**Utils:** SettingsManager, ShortcutManager, UndoRedoManager, AutosaveManager

#### Внешние зависимости (Provided Interfaces):
- **PySide6** - GUI фреймворк Qt для Python
- **OpenCV** - компьютерное зрение и видеообработка
- **FFmpeg** - кодирование/декодирование видео
- **MPV** - мультимедиа плеер

#### Паттерны коммуникации:
- Прямые вызовы методов для синхронных операций
- Qt Signals/Slots для асинхронных событий
- Dependency Injection для тестируемости

### Диаграмма развертывания:

#### Целевая среда:
**User Workstation:** Windows/Linux/macOS
**Python Version:** 3.8+
**Installation:** Standalone executable или pip install

#### Компоненты развертывания:
**Hockey Editor Pro Application:**
- MainWindow, VideoController, VideoProcessor
- ProjectManager, SettingsManager, UndoRedoManager

**Local Storage:**
- Project Files (.hep) - ZIP-архивы с метаданными
- Settings (QSettings) - нативное хранилище ОС
- Autosave Recovery - автоматическое восстановление
- Recent Projects - список последних файлов

#### Provided Interfaces:
**PySide6:** QApplication, QMainWindow, QGraphicsView, QTimer, QSettings
**OpenCV:** VideoCapture, frame processing, video I/O
**FFmpeg:** Video encoding, format conversion, codec support
**moviepy:** High-level video editing, clip concatenation

#### Артефакты данных:
**Input:** .mp4, .avi, .mov, .mkv, .flv видео файлы
**Output:** .mp4, .mov, .mkv экспортированные сегменты

### Системные требования:

**Runtime Requirements:**
- RAM: 4GB minimum, 8GB+ recommended
- Storage: 500MB application + project data
- Display: 1920x1080 minimum resolution
- GPU: Optional for hardware acceleration

**Deployment Options:**
- Single executable with embedded Python
- System-wide library installation
- User data in home/AppData directories
- Temporary files in system temp during export

## 8. Диаграмма деятельности варианта использования "Создание события" (Use Case Activity Diagram)

**Файл:** `use_case_activity_diagram.puml`  
**Назначение:** Детальное моделирование процесса создания события с точки зрения пользователя

### Основной workflow создания события:

#### Инициация процесса:
- Пользователь просматривает видео в режиме Playing
- Система ожидает нажатия горячих клавиш для создания событий

#### Обработка пользовательского ввода:
**Определение типа события:**
- По нажатой клавише определяется тип события (G - Гол, H - Бросок в створ, etc.)
- Получение текущего кадра воспроизведения для привязки события

**Два режима создания событий:**

**Динамический режим:**
- Первое нажатие клавиши: начало записи сегмента события
- Система устанавливает статус "Идет запись" и показывает визуальную индикацию
- Второе нажатие той же клавиши: завершение записи
- Автоматический расчет границ сегмента с учетом pre-roll (откат перед началом)
- Создание маркера события и автоматический переход к началу сегмента

**Режим фиксированной длины:**
- Одно нажатие клавиши создает сегмент заранее заданной длительности
- Автоматический расчет границ с учетом pre-roll и фиксированной продолжительности
- Создание маркера и автоматический переход к началу сегмента

#### Создание и отображение маркера:
- Инстанцирование объекта маркера с привязкой к таймлайну
- Добавление маркера в коллекцию событий
- Обновление визуального отображения таймлайна (цветная полоска на соответствующей дорожке)
- Отправка сигналов обновления всем связанным компонентам интерфейса

#### Система обратной связи:
- Визуальные индикаторы статуса процесса создания события
- Автоматическое позиционирование видео на начало созданного сегмента
- Обновление всех связанных представлений (timeline, списки событий)

### Управление состоянием и ошибками:

**Обработка прерываний:**
- Возможность отмены активной записи
- Восстановление предыдущего состояния при ошибках
- Сохранение незавершенных операций в стеке для возможной отмены

**Условия завершения просмотра:**
- Достижение конца видео: автоматическая остановка воспроизведения
- Пользовательское прерывание: pause/stop с сохранением позиции
- Циклическое продолжение процесса анализа

### Особенности пользовательского опыта:

**Интуитивность интерфейса:**
- Горячие клавиши для быстрого создания событий без отрыва от просмотра
- Визуальная обратная связь для каждого действия
- Автоматическое позиционирование для удобства анализа

**Гибкость настройки:**
- Поддержка различных типов событий с индивидуальными настройками
- Возможность настройки горячих клавиш и параметров записи
- Адаптация под разные стили работы аналитика

### Интеграция с другими функциями:

**Связь с другими вариантами использования:**
- Создание события является основой для редактирования (UC6)
- Созданные события используются для предпросмотра (UC7)
- Маркеры событий необходимы для экспорта (UC8 и UC14)

**Система Undo/Redo:**
- Каждое созданное событие сохраняется в истории операций
- Возможность отмены создания события с полным восстановлением состояния
- Поддержка многоуровневой отмены для сложных сессий анализа

## Заключение

Комплект из 8 UML диаграмм предоставляет полное архитектурное описание системы Hockey Editor Pro:

1. **Use Case Diagram** определяет функциональные требования
2. **Context Class Diagram** показывает высокоуровневую архитектуру
3. **Detailed Class Diagram** раскрывает внутреннюю структуру классов
4. **State Machine Diagram** моделирует поведение системы
5. **Activity Diagram** описывает бизнес-процессы
6. **Package Diagram** представляет архитектурные слои
7. **Component & Deployment Diagrams** описывают техническую реализацию
8. **Use Case Activity Diagram** детально моделирует процесс создания события

Диаграммы дополняют друг друга, обеспечивая многоуровневое понимание системы от бизнес-требований до технической реализации. Они служат основой для разработки, тестирования, сопровождения и масштабирования приложения.
