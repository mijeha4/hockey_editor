@startuml Extended State Machine Diagram
!theme plain
title Диаграмма состояний: Маркеры и Воспроизведение видео

' ================== СОСТОЯНИЯ ВИДЕОПЛЕЕРА ==================
state "Состояния воспроизведения видео" as VideoStates {
    [*] --> Stopped

    state Stopped as "Stopped (Остановлено)\n• Видео загружено, не играет\n• Позиция: кадр 0 или пауза\n• Кнопки управления активны"
    state Playing as "Playing (Воспроизведение)\n• Автоматическая смена кадров\n• Таймер кадров активен\n• Кнопки Пауза/Стоп доступны"
    state Paused as "Paused (Пауза)\n• Видео замерло на текущем кадре\n• Можно продолжить с места остановки\n• Все элементы управления активны"
    state "Frame-by-frame" as FrameByFrame

    Stopped --> Playing : play()\n[Клик Play или Пробел]
    Playing --> Paused : pause()\n[Клик Pause или Пробел]
    Paused --> Playing : play()\n[Клик Play или Пробел]
    Playing --> Stopped : stop()\n[Клик Stop или конец видео]
    Paused --> Stopped : stop()\n[Клик Stop]
    Paused --> FrameByFrame : frame_step()\n[Стрелки Влево/Вправо]
    FrameByFrame --> Paused : release_key()\n[Клавиша отпущена]

    note right of Playing
      **Детали состояния Playing:**
      • QTimer активен (интервал frame_time_ms)
      • Кадры меняются автоматически
      • Таймлайн обновляется в реальном времени
      • Возможна запись маркеров "на лету"
    end note

    note right of Paused
      **Детали состояния Paused:**
      • QTimer остановлен
      • Позиция к��дра зафиксирована
      • Разрешена перемотка (Seek)
      • Возможно редактирование маркеров
    end note
}

' ================== СОСТОЯНИЯ ЖИЗНЕННОГО ЦИКЛА МАРКЕРА ==================
state "Жизненный цикл маркера" as MarkerStates {
    [*] --> Created

    state Created as "Created (Создан)\n• Объект маркера создан в памяти\n• Базовые свойства заданы\n• Ещё не виден на таймлайне\n• Временное состояние"
    state Visible as "Visible (Видим)\n• Маркер отображен на таймлайне\n• Доступен для выбора\n• Часть коллекции проекта\n• Основное состояние"
    state Selected as "Selected (Выбран)\n• Маркер подсвечен\n• Доступны операции правки\n• Видны ручки растягивания\n• Режим одиночного выбора"
    state Edited as "Edited (Редактирование)\n• Изменение свойств маркера\n• Открыт диалог правки\n• Изменения не зафиксированы\n• Состояние поддерживает Undo"
    state Deleted as "Deleted (Удален)\n• Удален из коллекции\n• Скрыт с таймлайна\n• Можно восстановить (Undo)\n• Временное состояние перед очисткой"

    Created --> Visible : markers_changed.emit()\n[Маркер добавлен в список]
    Visible --> Selected : mouse_click()\n[Клик по маркеру]
    Selected --> Edited : double_click() / edit_dialog()\n[Начало редактирования]
    Edited --> Visible : save_changes()\n[Сохранение изменений]
    Edited --> Selected : cancel_edit()\n[Отмена правки]
    Selected --> Visible : deselect()\n[Клик в пустое место]
    Visible --> Deleted : delete_marker()\n[Удаление маркера]
    Deleted --> [*] : command_executed()\n[Команда Undo завершена]

    note right of Selected
      **Детали состояния Selected:**
      • Визуальная подсветка (цвет)
      • Видны ручки изменения размера
      • Доступно контекстное меню
      • Работают горячие клавиши (Delete)
    end note

    note right of Edited
      **Детали состояния Edited:**
      • Открыт EditSegmentDialog
      • Поля кадров активны
      • Поле заметки редактируемое
      • Включена валидация данных
    end note
}

' ================== ПЕРЕХОДЫ МЕЖДУ АВТОМАТАМИ ==================
Playing --> Created : hotkey_pressed()\n[При просмотре нажаты A/D/S]
Paused --> Created : hotkey_pressed()\n[На паузе нажаты A/D/S]
FrameByFrame --> Created : hotkey_pressed()\n[При покадровом просмотре нажаты A/D/S]

' ================== ОБЩИЕ ЗАМЕТКИ ==================
note as N1
  **Ключевые переходы:**
  • Состояние видео влияет на возможность создания маркеров
  • Состояния маркера управляют его жизненным циклом от создания до удаления
  • Оба автомата работают параллельно, но скоординированы
end note

note as N2
  **Координация системы:**
  • VideoController управляет обоими автоматами
  • Сигналы синхронизируют изменения (видео -> UI)
  • Система Undo/Redo обеспечивает целостность состояний при отмене
end note

@enduml