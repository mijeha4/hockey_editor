# Hockey Editor Pro - –ü–æ–ª–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã –∏ –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥

## –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

**Hockey Editor Pro** - –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –≤–∏–¥–µ–æ–º–æ–Ω—Ç–∞–∂–µ—Ä –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ö–æ–∫–∫–µ–π–Ω—ã—Ö –º–∞—Ç—á–µ–π. –ê–Ω–∞–ª–æ–≥ SportCode, LongoMatch, Hudl.

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ A/D/S –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—Ä–µ–∑–∫–æ–≤ (–ê—Ç–∞–∫–∞/–ó–∞—â–∏—Ç–∞/–°–º–µ–Ω–∞)
- –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–∞–π–º–ª–∞–π–Ω —Å 3 —Ü–≤–µ—Ç–Ω—ã–º–∏ –¥–æ—Ä–æ–∂–∫–∞–º–∏
- –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –í–∏–¥–µ–æ –ù–ï –ø–∞—É–∑–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ç—Ä–µ–∑–∫–æ–≤
- –≠–∫—Å–ø–æ—Ä—Ç –≤ MP4, JSON, CSV
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–∏–¥–µ–æ: MP4, AVI, MOV, MKV —á–µ—Ä–µ–∑ ffmpeg

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã

–ü—Ä–æ–≥—Ä–∞–º–º–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ MVC (Model-View-Controller) —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º PySide6 (Qt6 –¥–ª—è Python).

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:
- **main.py** - —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
- **core/** - –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ (–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã, –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä—ã)
- **models/** - –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö
- **ui/** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- **utils/** - –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
hockey_editor/
‚îú‚îÄ‚îÄ main.py                          # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ requirements.txt                 # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python
‚îú‚îÄ‚îÄ config.json                      # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ hockey_editor/
‚îÇ   ‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ video_controller.py      # –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤–∏–¥–µ–æ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ video_processor.py       # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–µ–æ —á–µ—Ä–µ–∑ OpenCV
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ event_creation_controller.py  # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è–º–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ exporter.py              # –≠–∫—Å–ø–æ—Ä—Ç –≤–∏–¥–µ–æ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ project_manager.py       # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ video_reader_thread.py   # –ü–æ—Ç–æ–∫ —á—Ç–µ–Ω–∏—è –≤–∏–¥–µ–æ
‚îÇ   ‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ marker.py                # –ú–æ–¥–µ–ª—å –º–∞—Ä–∫–µ—Ä–∞/–æ—Ç—Ä–µ–∑–∫–∞
‚îÇ   ‚îú‚îÄ‚îÄ ui/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main_window.py           # –ì–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ timeline.py              # –¢–∞–π–º–ª–∞–π–Ω –≤–∏–¥–∂–µ—Ç
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ timeline_graphics.py     # –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Ç–∞–π–º–ª–∞–π–Ω–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ video_window.py          # –û–∫–Ω–æ –≤–∏–¥–µ–æ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ settings_dialog.py       # –î–∏–∞–ª–æ–≥ –Ω–∞—Å—Ç—Ä–æ–µ–∫
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ export_dialog.py         # –î–∏–∞–ª–æ–≥ —ç–∫—Å–ø–æ—Ä—Ç–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ segment_editor.py        # –†–µ–¥–∞–∫—Ç–æ—Ä —Å–µ–≥–º–µ–Ω—Ç–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ edit_segment_dialog.py   # –î–∏–∞–ª–æ–≥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ preview_window.py        # –û–∫–Ω–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ custom_event_dialog.py   # –î–∏–∞–ª–æ–≥ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ settings_manager.py      # –ú–µ–Ω–µ–¥–∂–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫
‚îÇ       ‚îú‚îÄ‚îÄ custom_events.py         # –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ç–∏–ø—ã —Å–æ–±—ã—Ç–∏–π
‚îÇ       ‚îú‚îÄ‚îÄ undo_redo.py             # –û—Ç–º–µ–Ω–∞/–ø–æ–≤—Ç–æ—Ä –æ–ø–µ—Ä–∞—Ü–∏–π
‚îÇ       ‚îú‚îÄ‚îÄ autosave.py              # –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
‚îÇ       ‚îú‚îÄ‚îÄ shortcut_manager.py      # –ú–µ–Ω–µ–¥–∂–µ—Ä –≥–æ—Ä—è—á–∏—Ö –∫–ª–∞–≤–∏—à
‚îÇ       ‚îî‚îÄ‚îÄ time_utils.py            # –£—Ç–∏–ª–∏—Ç—ã –≤—Ä–µ–º–µ–Ω–∏
‚îú‚îÄ‚îÄ assets/                          # –†–µ—Å—É—Ä—Å—ã (–∏–∫–æ–Ω–∫–∏)
‚îú‚îÄ‚îÄ docs/                            # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ projects/                        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã
‚îî‚îÄ‚îÄ README.md                        # –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
```

## –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (requirements.txt)

```
PySide6>=6.6.0
opencv-python>=4.8.0
numpy>=1.24.0
Pillow>=10.0.0
openpyxl>=3.1.0
setuptools>=65.0.0
wheel>=0.40.0
pandas>=2.0.0
reportlab>=4.0.0
```

## –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º—ã

### 1. main.py - –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞

```python
#!/usr/bin/env python3
"""
Hockey Editor Pro - Professional Video Analysis Tool
Main entry point
"""

import sys
import os

# –î–æ–±–∞–≤–∏—Ç—å hockey_editor –≤ –ø—É—Ç—å
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'hockey_editor'))

from PySide6.QtWidgets import QApplication
from hockey_editor.core.video_controller import VideoController
from hockey_editor.ui.main_window import MainWindow


def main():
    """–ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."""
    app = QApplication(sys.argv)
    app.setApplicationName("Hockey Editor Pro")
    app.setApplicationVersion("2.0.0")

    # –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
    controller = VideoController()

    # –°–æ–∑–¥–∞—Ç—å –≥–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ
    window = MainWindow(controller)
    window.show()

    sys.exit(app.exec())


if __name__ == "__main__":
    main()
```

### 2. core/video_controller.py - –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤–∏–¥–µ–æ

```python
from PySide6.QtCore import QObject, Signal, QTimer
from typing import List, Optional, Dict
from enum import Enum
import json
import os
from .video_processor import VideoProcessor
from ..models.marker import Marker, EventType
from ..utils.settings_manager import get_settings_manager
from ..utils.custom_events import get_custom_event_manager


class RecordingMode(Enum):
    """–†–µ–∂–∏–º—ã —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ç—Ä–µ–∑–∫–æ–≤."""
    DYNAMIC = "dynamic"          # –î–≤–∞ –Ω–∞–∂–∞—Ç–∏—è = –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü
    FIXED_LENGTH = "fixed_length"  # –û–¥–Ω–æ –Ω–∞–∂–∞—Ç–∏–µ = –æ—Ç—Ä–µ–∑–æ–∫ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–ª–∏–Ω—ã


class VideoController(QObject):
    """–ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤–∏–¥–µ–æ —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è."""

    # –°–∏–≥–Ω–∞–ª—ã
    playback_time_changed = Signal(int)  # frame_idx
    markers_changed = Signal()
    recording_status_changed = Signal(str, str)  # event_type (A/D/S), status (Recording/Complete)
    timeline_update = Signal()
    current_frame_update = Signal(int)  # frame_idx
    frame_ready = Signal(object)  # np.ndarray (—Ç–µ–∫—É—â–∏–π –∫–∞–¥—Ä)

    def __init__(self):
        super().__init__()

        self.processor = VideoProcessor()
        self.markers: List[Marker] = []

        # SettingsManager –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
        self.settings = get_settings_manager()

        # CustomEventManager - –º–µ–Ω–µ–¥–∂–µ—Ä —Å–æ–±—ã—Ç–∏–π
        self.event_manager = get_custom_event_manager()

        # UndoRedoManager
        from ..utils.undo_redo import UndoRedoManager
        self.undo_redo = UndoRedoManager()

        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
        self.playing = False
        self.playback_timer = QTimer()
        self.playback_timer.timeout.connect(self._on_playback_tick)
        self.frame_time_ms = 33  # ~30 FPS (—Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ FPS –≤–∏–¥–µ–æ)

        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ç—Ä–µ–∑–∫–æ–≤ (–∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ QSettings)
        mode_str = self.settings.load_recording_mode()
        self.recording_mode = RecordingMode(mode_str)
        self.fixed_duration_sec = self.settings.load_fixed_duration()
        self.pre_roll_sec = self.settings.load_pre_roll()
        self.post_roll_sec = self.settings.load_post_roll()

        # –°–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∑–∞–ø–∏—Å–∏ (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º)
        self.is_recording = False
        self.recording_event_name: Optional[str] = None  # –ò–º—è —Å–æ–±—ã—Ç–∏—è –≤–º–µ—Å—Ç–æ EventType
        self.recording_start_frame: Optional[int] = None

    def load_video(self, video_path: str) -> bool:
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ—Ñ–∞–π–ª (–ü–ê–£–ó–ò–†–û–í–ê–ù!)."""
        success = self.processor.load(video_path)
        if success:
            # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å frame_time_ms –Ω–∞ –æ—Å–Ω–æ–≤–µ FPS –≤–∏–¥–µ–æ
            fps = self.processor.get_fps()
            if fps > 0:
                self.frame_time_ms = int(1000 / fps)

            # –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤–∏–¥–µ–æ –Ω–∞ –ø–∞—É–∑–µ
            self.playing = False
            self.playback_timer.stop()

            # –û–±–Ω–æ–≤–∏—Ç—å –º–∞—Ä–∫–µ—Ä—ã –∏ UI
            self.markers = []
            self.markers_changed.emit()
            self.playback_time_changed.emit(0)
            self.current_frame_update.emit(0)
            self.timeline_update.emit()

            # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä –Ω–∞ UI
            frame = self.processor.get_current_frame()
            if frame is not None:
                self.frame_ready.emit(frame)

        return success

    def play(self):
        """–ù–∞—á–∞—Ç—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ."""
        if self.processor.cap is None or self.playing:
            return

        self.playing = True
        self.playback_timer.start(self.frame_time_ms)

    def pause(self):
        """–ü–∞—É–∑–∞."""
        self.playing = False
        self.playback_timer.stop()

    def toggle_play_pause(self):
        """–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å Play/Pause."""
        if self.playing:
            self.pause()
        else:
            self.play()

    def stop(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç –≤ –Ω–∞—á–∞–ª–æ."""
        self.pause()
        self.seek_frame(0)

    def seek_frame(self, frame_idx: int):
        """–ü–µ—Ä–µ–º–æ—Ç–∞—Ç—å –Ω–∞ –∫–∞–¥—Ä (–ù–ï –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ)."""
        if self.processor.cap is None:
            return

        self.processor.seek(frame_idx)

        # –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∏–≥–Ω–∞–ª—ã –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
        self.playback_time_changed.emit(frame_idx)
        self.current_frame_update.emit(frame_idx)
        self.timeline_update.emit()

        # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞–¥—Ä –Ω–∞ UI
        frame = self.processor.get_current_frame()
        if frame is not None:
            self.frame_ready.emit(frame)

    def _on_playback_tick(self):
        """–¢–∞–π–º–µ—Ä –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è - –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π frame_time_ms."""
        if not self.processor.cap or not self.playing:
            return

        # –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä
        success = self.processor.advance_frame()
        if not success:
            # –ö–æ–Ω–µ—Ü –≤–∏–¥–µ–æ
            self.pause()
            return

        # –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å –∫–∞–¥—Ä–∞
        current_frame_idx = self.processor.get_current_frame_idx()

        # –≠–º–∏—Ç —Å–∏–≥–Ω–∞–ª–æ–≤ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
        self.playback_time_changed.emit(current_frame_idx)
        self.current_frame_update.emit(current_frame_idx)
        self.timeline_update.emit()

        # –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∫–∞–¥—Ä –Ω–∞ UI
        frame = self.processor.get_current_frame()
        if frame is not None:
            self.frame_ready.emit(frame)

    def on_hotkey_pressed(self, key: str):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –≥–æ—Ä—è—á–µ–π –∫–ª–∞–≤–∏—à–∏."""
        # –ù–∞–π—Ç–∏ —Å–æ–±—ã—Ç–∏–µ –ø–æ –∫–ª–∞–≤–∏—à–µ
        event = self.event_manager.get_event_by_hotkey(key)
        if not event:
            return  # –ù–µ—Ç —Å–æ–±—ã—Ç–∏—è –¥–ª—è —ç—Ç–æ–π –∫–ª–∞–≤–∏—à–∏

        current_frame = self.processor.get_current_frame_idx()
        event_name = event.name

        if self.recording_mode == RecordingMode.DYNAMIC:
            self._handle_dynamic_mode(event_name, current_frame)
        elif self.recording_mode == RecordingMode.FIXED_LENGTH:
            self._handle_fixed_length_mode(event_name, current_frame)

    def _handle_dynamic_mode(self, event_name: str, current_frame: int):
        """–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º: –¥–≤–∞ –Ω–∞–∂–∞—Ç–∏—è = –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü."""
        if not self.is_recording:
            # –ù–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏
            self.is_recording = True
            self.recording_event_name = event_name
            self.recording_start_frame = current_frame
            self.recording_status_changed.emit(event_name, "Recording")
            self.timeline_update.emit()
        elif self.recording_event_name == event_name:
            # –ö–æ–Ω–µ—Ü –∑–∞–ø–∏—Å–∏
            pre_roll_frames = max(0, int(self.pre_roll_sec * self.processor.fps))
            start_frame = max(0, self.recording_start_frame - pre_roll_frames)

            marker = Marker(
                start_frame=start_frame,
                end_frame=current_frame,
                event_name=event_name,
                note=""
            )
            self.markers.append(marker)

            # –ê–≤—Ç–æ–æ—Ç–∫–∞—Ç –Ω–∞—á–∞–ª–∞ –æ—Ç—Ä–µ–∑–∫–∞
            self.seek_frame(start_frame)

            self.is_recording = False
            self.recording_event_name = None
            self.recording_start_frame = None

            self.recording_status_changed.emit(event_name, "Complete")
            self.markers_changed.emit()
            self.timeline_update.emit()

    def _handle_fixed_length_mode(self, event_name: str, current_frame: int):
        """–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª–∏–Ω–∞: –æ–¥–Ω–æ –Ω–∞–∂–∞—Ç–∏–µ = –æ—Ç—Ä–µ–∑–æ–∫ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–ª–∏–Ω—ã."""
        # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –≥—Ä–∞–Ω–∏—Ü—ã
        fixed_frames = int(self.fixed_duration_sec * self.processor.fps)
        pre_roll_frames = max(0, int(self.pre_roll_sec * self.processor.fps))

        start_frame = max(0, current_frame - pre_roll_frames)
        end_frame = min(self.processor.total_frames - 1, current_frame + fixed_frames - pre_roll_frames)

        # –°–æ–∑–¥–∞—Ç—å –æ—Ç—Ä–µ–∑–æ–∫
        marker = Marker(
            start_frame=start_frame,
            end_frame=end_frame,
            event_name=event_name,
            note=""
        )
        self.markers.append(marker)

        # –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
        self.recording_status_changed.emit(event_name, "Fixed")

        # –ê–≤—Ç–æ–æ—Ç–∫–∞—Ç –Ω–∞—á–∞–ª–∞ –æ—Ç—Ä–µ–∑–∫–∞
        self.seek_frame(start_frame)

        self.markers_changed.emit()
        self.timeline_update.emit()

    def cancel_recording(self):
        """–û—Ç–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é –∑–∞–ø–∏—Å—å."""
        if self.is_recording:
            self.is_recording = False
            self.recording_event_name = None
            self.recording_start_frame = None
            self.recording_status_changed.emit("", "Cancelled")
            self.timeline_update.emit()

    def delete_marker(self, idx: int):
        """–£–¥–∞–ª–∏—Ç—å –æ—Ç—Ä–µ–∑–æ–∫ (—Å undo/redo)."""
        if 0 <= idx < len(self.markers):
            from ..utils.undo_redo import DeleteMarkerCommand
            command = DeleteMarkerCommand(self.markers, idx)
            self.undo_redo.push_command(command)
            self.markers_changed.emit()
            self.timeline_update.emit()

    def clear_markers(self):
        """–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ—Ç—Ä–µ–∑–∫–∏ (—Å undo/redo)."""
        from ..utils.undo_redo import ClearMarkersCommand
        command = ClearMarkersCommand(self.markers)
        self.undo_redo.push_command(command)
        self.markers_changed.emit()
        self.timeline_update.emit()

    def set_recording_mode(self, mode: RecordingMode):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ–∂–∏–º —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ç—Ä–µ–∑–∫–æ–≤."""
        self.recording_mode = mode
        self.settings.save_recording_mode(mode.value)

    def set_fixed_duration(self, seconds: int):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –¥–ª–∏–Ω—É –æ—Ç—Ä–µ–∑–∫–∞."""
        self.fixed_duration_sec = seconds
        self.settings.save_fixed_duration(seconds)

    def set_pre_roll(self, seconds: float):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ—Ç–∫–∞—Ç –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –æ—Ç—Ä–µ–∑–∫–∞."""
        self.pre_roll_sec = seconds
        self.settings.save_pre_roll(seconds)

    def set_post_roll(self, seconds: float):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ–Ω–µ—Ü –æ—Ç—Ä–µ–∑–∫–∞."""
        self.post_roll_sec = seconds
        self.settings.save_post_roll(seconds)

    # –ú–µ—Ç–æ–¥ update_hotkeys —É–±—Ä–∞–Ω - hotkeys —Ç–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ CustomEventManager

    def get_current_frame_idx(self) -> int:
        """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å –∫–∞–¥—Ä–∞."""
        return self.processor.get_current_frame_idx()

    def get_fps(self) -> float:
        """–ü–æ–ª—É—á–∏—Ç—å FPS –≤–∏–¥–µ–æ."""
        return self.processor.get_fps()

    def get_total_frames(self) -> int:
        """–ü–æ–ª—É—á–∏—Ç—å –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–¥—Ä–æ–≤."""
        return self.processor.get_total_frames()

    def cleanup(self):
        """–û—á–∏—Å—Ç–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã."""
        self.pause()
        self.processor.cleanup()
        self.markers.clear()

    # ===== –ü–†–û–ï–ö–¢–´ =====

    def save_project(self, file_path: str) -> bool:
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –≤ —Ñ–∞–π–ª."""
        from .project_manager import ProjectManager, Project

        project = Project(
            name=self.processor.filename or "Untitled",
            video_path=self.processor.path,
            fps=self.get_fps()
        )
        project.markers = self.markers.copy()

        success = ProjectManager.save_project(project, file_path)
        if success:
            ProjectManager.add_to_recent(file_path)
        return success

    def load_project(self, file_path: str) -> bool:
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –∏–∑ —Ñ–∞–π–ª–∞."""
        from .project_manager import ProjectManager

        project = ProjectManager.load_project(file_path)
        if not project:
            return False

        # –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ
        if project.video_path and os.path.exists(project.video_path):
            if not self.load_video(project.video_path):
                return False

        # –ó–∞–≥—Ä—É–∑–∏—Ç—å –º–∞—Ä–∫–µ—Ä—ã
        self.markers = project.markers.copy()
        self.markers_changed.emit()

        ProjectManager.add_to_recent(file_path)
        return True

    def get_recent_projects(self) -> List[str]:
        """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–µ–¥–∞–≤–Ω–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤."""
        from .project_manager import ProjectManager
        return ProjectManager.get_recent_projects()

    # ===== UNDO/REDO =====

    def undo(self):
        """–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –æ–ø–µ—Ä–∞—Ü–∏—é."""
        self.undo_redo.undo()
        self.markers_changed.emit()

    def redo(self):
        """–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –æ—Ç–º–µ–Ω—ë–Ω–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é."""
        self.undo_redo.redo()
        self.markers_changed.emit()

    def can_undo(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –º–æ–∂–Ω–æ –ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å."""
        return self.undo_redo.can_undo()

    def can_redo(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –º–æ–∂–Ω–æ –ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å."""
        return self.undo_redo.can_redo()
```

### 3. core/video_processor.py - –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–∏–¥–µ–æ

```python
import cv2
import numpy as np
from typing import Optional, Tuple
import os


class VideoProcessor:
    """–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–µ–æ —á–µ—Ä–µ–∑ OpenCV (cv2.VideoCapture) —Å –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–µ–π —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–¥—Ä–∞."""

    def __init__(self):
        self.cap: Optional[cv2.VideoCapture] = None
        self.video_path: Optional[str] = None
        self.fps: float = 0.0
        self.total_frames: int = 0
        self.current_frame_idx: int = 0
        self.frame_width: int = 0
        self.frame_height: int = 0
        self._current_frame_buffer: Optional[np.ndarray] = None  # –ë—É—Ñ–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–¥—Ä–∞

    def load(self, video_path: str) -> bool:
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ—Ñ–∞–π–ª."""
        if not os.path.exists(video_path):
            return False

        # –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –≤–∏–¥–µ–æ
        self.cleanup()

        self.cap = cv2.VideoCapture(video_path)
        if not self.cap.isOpened():
            self.cap = None
            return False

        self.video_path = video_path
        self.fps = self.cap.get(cv2.CAP_PROP_FPS)
        self.total_frames = int(self.cap.get(cv2.CAP_PROP_FRAME_COUNT))
        self.frame_width = int(self.cap.get(cv2.CAP_PROP_FRAME_WIDTH))
        self.frame_height = int(self.cap.get(cv2.CAP_PROP_FRAME_HEIGHT))
        self.current_frame_idx = 0

        # –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–µ—Ä–≤—ã–π –∫–∞–¥—Ä –≤ –±—É—Ñ–µ—Ä
        self._read_and_buffer_frame()

        return True

    def seek(self, frame_idx: int) -> bool:
        """–ü–µ—Ä–µ–º–æ—Ç–∞—Ç—å –Ω–∞ –∫–∞–¥—Ä (–ë–ï–ó –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è)."""
        if not self.cap:
            return False

        frame_idx = max(0, min(frame_idx, self.total_frames - 1))
        ret = self.cap.set(cv2.CAP_PROP_POS_FRAMES, frame_idx)
        if ret:
            self.current_frame_idx = frame_idx
            self._read_and_buffer_frame()
        return ret

    def advance_frame(self) -> bool:
        """–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä (–¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è)."""
        if not self.cap:
            return False

        # –ü—Ä–æ—Å—Ç–æ —á–∏—Ç–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä
        ret, frame = self.cap.read()
        if ret:
            self.current_frame_idx = int(self.cap.get(cv2.CAP_PROP_POS_FRAMES))
            self._current_frame_buffer = frame
            return True
        return False

    def _read_and_buffer_frame(self) -> bool:
        """–ü—Ä–æ—á–∏—Ç–∞—Ç—å –∫–∞–¥—Ä —Å —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±—É—Ñ–µ—Ä."""
        if not self.cap:
            return False

        ret, frame = self.cap.read()
        if ret:
            self._current_frame_buffer = frame
            return True
        return False

    def get_current_frame(self) -> Optional[np.ndarray]:
        """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∫–∞–¥—Ä –∏–∑ –±—É—Ñ–µ—Ä–∞ (–ë–ï–ó —á—Ç–µ–Ω–∏—è)."""
        return self._current_frame_buffer

    def get_frame_at(self, frame_idx: int) -> Optional[np.ndarray]:
        """–ü–æ–ª—É—á–∏—Ç—å –∫–∞–¥—Ä –ø–æ –∏–Ω–¥–µ–∫—Å—É (–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥)."""
        if not self.cap:
            return None

        self.seek(frame_idx)
        return self.get_current_frame()

    def get_current_time(self) -> float:
        """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è (—Å–µ–∫—É–Ω–¥—ã)."""
        if self.fps == 0:
            return 0.0
        return self.current_frame_idx / self.fps

    def get_fps(self) -> float:
        """–ü–æ–ª—É—á–∏—Ç—å FPS –≤–∏–¥–µ–æ."""
        return self.fps

    def get_total_frames(self) -> int:
        """–ü–æ–ª—É—á–∏—Ç—å –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–¥—Ä–æ–≤."""
        return self.total_frames

    def get_total_time(self) -> float:
        """–ü–æ–ª—É—á–∏—Ç—å –æ–±—â—É—é –¥–ª–∏–Ω—É –≤–∏–¥–µ–æ (—Å–µ–∫—É–Ω–¥—ã)."""
        if self.fps == 0:
            return 0.0
        return self.total_frames / self.fps

    def get_current_frame_idx(self) -> int:
        """–ü–æ–ª—É—á–∏—Ç—å –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ –∫–∞–¥—Ä–∞."""
        return self.current_frame_idx

    def get_resolution(self) -> Tuple[int, int]:
        """–ü–æ–ª—É—á–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ (width, height)."""
        return self.frame_width, self.frame_height

    def cleanup(self):
        """–ó–∞–∫—Ä—ã—Ç—å –≤–∏–¥–µ–æ—Ñ–∞–π–ª."""
        if self.cap:
            self.cap.release()
            self.cap = None
        self.video_path = None
        self.fps = 0.0
        self.total_frames = 0
        self.current_frame_idx = 0
        self._current_frame_buffer = None

    def __del__(self):
        self.cleanup()
```

### 4. models/marker.py - –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–∞

```python
from dataclasses import dataclass
from enum import Enum

class EventType(Enum):
    """–£—Å—Ç–∞—Ä–µ–≤—à–∏–π enum - –¥–ª—è backwards compatibility."""
    ATTACK = "–ê—Ç–∞–∫–∞"
    DEFENSE = "–ó–∞—â–∏—Ç–∞"
    SHIFT = "–°–º–µ–Ω–∞"

@dataclass
class Marker:
    start_frame: int
    end_frame: int
    event_name: str  # –ù–æ–≤–æ–µ –ø–æ–ª–µ: –∏–º—è —Å–æ–±—ã—Ç–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Attack", "Defense", "MyCustomEvent")
    note: str = ""

    def to_dict(self):
        return {
            "start_frame": self.start_frame,
            "end_frame": self.end_frame,
            "event_name": self.event_name,  # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è —Å–æ–±—ã—Ç–∏—è
            "note": self.note
        }

    @classmethod
    def from_dict(cls, data):
        # Backwards compatibility: –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–ª–µ "type" –≤–º–µ—Å—Ç–æ "event_name"
        if "type" in data and "event_name" not in data:
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–π enum value –≤ –∏–º—è —Å–æ–±—ã—Ç–∏—è
            event_type_value = data["type"]
            # –ú–∞–ø–ø–∏–Ω–≥ —Å—Ç–∞—Ä—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –Ω–∞ –∏–º–µ–Ω–∞
            type_to_name = {
                "–ê—Ç–∞–∫–∞": "Attack",
                "–ó–∞—â–∏—Ç–∞": "Defense",
                "–°–º–µ–Ω–∞": "Shift"
            }
            event_name = type_to_name.get(event_type_value, event_type_value)
        else:
            event_name = data.get("event_name", "Attack")  # Default to Attack

        return cls(
            start_frame=data["start_frame"],
            end_frame=data["end_frame"],
            event_name=event_name,
            note=data.get("note", "")
        )
```

### 5. ui/main_window.py - –ì–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```python
from PySide6.QtCore import Qt, QTimer
from PySide6.QtGui import QPixmap, QImage, QFont, QKeySequence, QShortcut
from PySide6.QtWidgets import (
    QMainWindow, QWidget, QVBoxLayout, QHBoxLayout, QPushButton, QSlider,
    QLabel, QListWidget, QListWidgetItem, QFileDialog, QComboBox, QSpinBox,
    QMessageBox, QSpinBox
)
import cv2
import numpy as np
from pathlib import Path
from .timeline_graphics import TimelineGraphicsView
from .segment_editor import SegmentEditorDialog
from .settings_dialog import SettingsDialog
from ..models.marker import EventType
from ..utils.settings_manager import get_settings_manager
from ..utils.custom_events import get_custom_event_manager
from ..utils.shortcut_manager import ShortcutManager



class MainWindow(QMainWindow):
    """–ì–ª–∞–≤–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."""

    def __init__(self, controller):
        super().__init__()
        self.controller = controller
        self.settings_manager = get_settings_manager()
        self.event_manager = get_custom_event_manager()
        self.event_manager.setParent(self)  # Ensure proper Qt object ownership
        self.shortcut_manager = ShortcutManager(self)

        # –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        from ..utils.autosave import AutosaveManager
        self.autosave_manager = AutosaveManager(controller)
        self.autosave_manager.autosave_completed.connect(self._on_autosave_completed)

        self.setWindowTitle("Hockey Editor Pro - Professional Video Analysis")
        self.setGeometry(0, 0, 1800, 1000)
        self.setStyleSheet(self._get_dark_stylesheet())

        # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ drag-drop –¥–ª—è –≤–∏–¥–µ–æ
        self.setAcceptDrops(True)

        self.setup_ui()
        self.connect_signals()
        self._setup_shortcuts()
        self._create_menu()

    def _create_menu(self):
        """–°–æ–∑–¥–∞—Ç—å –º–µ–Ω—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è."""
        menubar = self.menuBar()

        # File menu
        file_menu = menubar.addMenu("File")

        new_action = file_menu.addAction("New Project")
        new_action.setShortcut("Ctrl+N")
        new_action.triggered.connect(self._on_new_project)

        open_action = file_menu.addAction("Open Project")
        open_action.setShortcut("Ctrl+O")
        open_action.triggered.connect(self._on_open_project)

        save_action = file_menu.addAction("Save Project")
        save_action.setShortcut("Ctrl+S")
        save_action.triggered.connect(self._on_save_project)

        save_as_action = file_menu.addAction("Save Project As...")
        save_as_action.setShortcut("Ctrl+Shift+S")
        save_action.triggered.connect(self._on_save_project_as)

        file_menu.addSeparator()

        # Recent projects
        self.recent_menu = file_menu.addMenu("Recent Projects")
        self._update_recent_menu()

        file_menu.addSeparator()

        exit_action = file_menu.addAction("Exit")
        exit_action.triggered.connect(self.close)

        # Help menu
        help_menu = menubar.addMenu("Help")
        about_action = help_menu.addAction("About")
        about_action.triggered.connect(self._on_about)

    def setup_ui(self):
        """–°–æ–∑–¥–∞—Ç—å UI."""
        central = QWidget()
        self.setCentralWidget(central)

        main_layout = QVBoxLayout()
        main_layout.setContentsMargins(10, 10, 10, 10)
        main_layout.setSpacing(5)

        # ===== –í–ï–†–•–ù–Ø–Ø –ß–ê–°–¢–¨ (–≤–∏–¥–µ–æ + —Å–ø–∏—Å–æ–∫ —Å–ø—Ä–∞–≤–∞) =====
        top_layout = QHBoxLayout()

        # –í–∏–¥–µ–æ (70%)
        video_layout = QVBoxLayout()

        # –í–∏–¥–µ–æ –≤–∏–¥–∂–µ—Ç
        self.video_label = QLabel()
        self.video_label.setMinimumSize(800, 450)
        self.video_label.setStyleSheet("background-color: black; border: 1px solid grey;")
        video_layout.addWidget(self.video_label)

        # –ö–æ–Ω—Ç—Ä–æ–ª—ã –≤–∏–¥–µ–æ
        controls_layout = QHBoxLayout()

        self.play_btn = QPushButton("‚ñ∂ Play")
        self.play_btn.setMaximumWidth(80)
        self.play_btn.setToolTip("Play/Pause video (Space)")
        self.play_btn.clicked.connect(self._on_play_pause_clicked)
        controls_layout.addWidget(self.play_btn)

        # –ü–æ–ª–∑—É–Ω–æ–∫ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        self.progress_slider = QSlider(Qt.Orientation.Horizontal)
        self.progress_slider.setToolTip("Seek to frame")
        self.progress_slider.sliderMoved.connect(self._on_progress_slider_moved)
        controls_layout.addWidget(self.progress_slider)

        # –í—Ä–µ–º—è
        self.time_label = QLabel("00:00 / 00:00")
        self.time_label.setMaximumWidth(100)
        self.time_label.setToolTip("Current time / Total duration")
        controls_layout.addWidget(self.time_label)

        # –°–∫–æ—Ä–æ—Å—Ç—å (–≤—Å–µ–≥–¥–∞ 1x)
        speed_label = QLabel("1.0x")
        speed_label.setMaximumWidth(40)
        controls_layout.addWidget(speed_label)

        # –û—Ç–∫—Ä—ã—Ç—å –≤–∏–¥–µ–æ
        open_btn = QPushButton("üìÅ Open")
        open_btn.setMaximumWidth(70)
        open_btn.setToolTip("Open video file (Ctrl+O)")
        open_btn.clicked.connect(self._on_open_video)
        controls_layout.addWidget(open_btn)

        video_layout.addLayout(controls_layout)
        top_layout.addLayout(video_layout, 7)

        # –°–ø–∏—Å–æ–∫ –æ—Ç—Ä–µ–∑–∫–æ–≤ (30%)
        list_layout = QVBoxLayout()
        list_layout.addWidget(QLabel("Segments:"))

        self.markers_list = QListWidget()
        self.markers_list.itemDoubleClicked.connect(self._on_marker_double_clicked)
        list_layout.addWidget(self.markers_list)

        # –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–æ–º
        marker_btn_layout = QHBoxLayout()

        delete_btn = QPushButton("üóëÔ∏è Delete")
        delete_btn.clicked.connect(self._on_delete_marker)
        marker_btn_layout.addWidget(delete_btn)

        clear_btn = QPushButton("üóëÔ∏è Clear All")
        clear_btn.clicked.connect(self._on_clear_markers)
        marker_btn_layout.addWidget(clear_btn)

        list_layout.addLayout(marker_btn_layout)

        top_layout.addLayout(list_layout, 3)

        main_layout.addLayout(top_layout)

        # ===== –¢–ê–ô–ú–õ–ê–ô–ù =====
        main_layout.addWidget(QLabel("Timeline:"))
        self.timeline_widget = TimelineGraphicsView()
        self.timeline_widget.main_window = self  # Set reference for double-click
        self.timeline_widget.set_controller(self.controller)
        main_layout.addWidget(self.timeline_widget)

        # ===== –ö–ù–û–ü–ö–ò –°–û–ë–´–¢–ò–ô (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ) –ò –ù–ê–°–¢–†–û–ô–ö–ò =====
        event_layout = QHBoxLayout()

        # –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –∫–Ω–æ–ø–æ–∫ —Å–æ–±—ã—Ç–∏–π
        self.event_buttons_layout = QHBoxLayout()
        event_layout.addLayout(self.event_buttons_layout)

        # –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏ –∏–∑ event_manager
        self._update_event_buttons()

        event_layout.addStretch()

        # –ö–Ω–æ–ø–∫–∏ undo/redo
        undo_btn = QPushButton("‚Ü∂ Undo")
        undo_btn.setMaximumWidth(80)
        undo_btn.setToolTip("Undo last operation (Ctrl+Z)")
        undo_btn.clicked.connect(self._on_undo_clicked)
        event_layout.addWidget(undo_btn)

        redo_btn = QPushButton("‚Ü∑ Redo")
        redo_btn.setMaximumWidth(80)
        redo_btn.setToolTip("Redo last operation (Ctrl+Shift+Z)")
        redo_btn.clicked.connect(self._on_redo_clicked)
        event_layout.addWidget(redo_btn)

        # –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        preview_btn = QPushButton("üëÅÔ∏è Preview")
        preview_btn.setToolTip("Preview and filter segments")
        preview_btn.clicked.connect(self._on_preview_clicked)
        event_layout.addWidget(preview_btn)

        # –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        settings_btn = QPushButton("‚öôÔ∏è Settings")
        settings_btn.setToolTip("Open settings dialog (Ctrl+,)")
        settings_btn.clicked.connect(self._on_settings_clicked)
        event_layout.addWidget(settings_btn)

        # –ö–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞
        export_btn = QPushButton("üíæ Export")
        export_btn.setToolTip("Export segments to video (Ctrl+E)")
        export_btn.clicked.connect(self._on_export_clicked)
        event_layout.addWidget(export_btn)

        event_layout.addStretch()

        # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å-–±–∞—Ä
        self.status_label = QLabel("Ready")
        self.status_label.setStyleSheet("color: #ffcc00;")
        self.status_label.setMinimumWidth(400)
        event_layout.addWidget(self.status_label)

        main_layout.addLayout(event_layout)

        central.setLayout(main_layout)

        # –ü–æ–¥–∫–ª—é—á–∏—Ç—å —Å–∏–≥–Ω–∞–ª frame_ready –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ
        self.controller.frame_ready.connect(self._on_frame_ready)

    def _create_event_button(self, text: str, color: str) -> QPushButton:
        """–°–æ–∑–¥–∞—Ç—å –∫–Ω–æ–ø–∫—É —Å–æ–±—ã—Ç–∏—è."""
        btn = QPushButton(text)
        btn.setMinimumSize(120, 90)
        btn.setFont(QFont("Arial", 14, QFont.Weight.Bold))
        btn.setStyleSheet(f"""
            QPushButton {{
                background-color: {color};
                color: white;
                border: 2px solid {color};
                border-radius: 5px;
            }}
            QPushButton:hover {{
                background-color: {self._lighten_color(color)};
            }}
            QPushButton:pressed {{
                border: 3px solid yellow;
                background-color: {self._lighten_color(color)};
            }}
        """)
        return btn

    def _lighten_color(self, color_hex: str) -> str:
        """–°–≤–µ—Ç–ª–∞—è –≤–µ—Ä—Å–∏—è —Ü–≤–µ—Ç–∞ –¥–ª—è hover."""
        # –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
        return color_hex.replace("00", "33").replace("8b", "bb")

    def connect_signals(self):
        """–ü–æ–¥–∫–ª—é—á–∏—Ç—å —Å–∏–≥–Ω–∞–ª—ã –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞."""
        self.controller.playback_time_changed.connect(self._on_playback_time_changed)
        self.controller.markers_changed.connect(self._on_markers_changed)
        self.controller.recording_status_changed.connect(self._on_recording_status_changed)
        self.controller.timeline_update.connect(self._on_timeline_update)
        self.controller.frame_ready.connect(self._on_frame_ready)

        # –ü–æ–¥–∫–ª—é—á–∏—Ç—å —Å–∏–≥–Ω–∞–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π
        self.event_manager.events_changed.connect(self._on_events_changed)
        self.event_manager.events_changed.connect(self._on_events_changed_timeline)

        # –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        self.autosave_manager.start()

    def _on_play_pause_clicked(self):
        """–ö–Ω–æ–ø–∫–∞ Play/Pause - –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ."""
        self.controller.toggle_play_pause()
        self._update_play_btn_text()

    def _update_play_btn_text(self):
        """–û–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ Play/Pause."""
        if self.controller.playing:
            self.play_btn.setText("‚è∏ Pause")
        else:
            self.play_btn.setText("‚ñ∂ Play")

    def _on_progress_slider_moved(self):
        """–î–≤–∏–∂–µ–Ω–∏–µ –ø–æ–ª–∑—É–Ω–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞."""
        frame_idx = self.progress_slider.value()
        self.controller.seek_frame(frame_idx)

    def _on_open_video(self):
        """–û—Ç–∫—Ä—ã—Ç—å –≤–∏–¥–µ–æ."""
        path, _ = QFileDialog.getOpenFileName(
            self, "Open Video", "", "Videos (*.mp4 *.avi *.mov *.mkv);;All (*.*)"
        )
        if path:
            if self.controller.load_video(path):
                self.status_label.setText(f"‚úì Loaded: {path.split('/')[-1]}")
                self._update_play_btn_text()
                self.progress_slider.setMaximum(self.controller.get_total_frames())
            else:
                QMessageBox.critical(self, "Error", "Failed to load video")

    def _on_event_btn_clicked(self, event_name: str):
        """–ù–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ —Å–æ–±—ã—Ç–∏—è."""
        self.controller.on_hotkey_pressed(event_name.upper())  # –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –æ–∂–∏–¥–∞–µ—Ç key (—Å—Ç—Ä–æ–∫–∞)

    def _on_undo_clicked(self):
        """–û—Ç–º–µ–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é."""
        self.controller.undo()
        self._on_markers_changed()

    def _on_redo_clicked(self):
        """–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é."""
        self.controller.redo()
        self._on_markers_changed()

    def _on_preview_clicked(self):
        """–û—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—Ç—Ä–µ–∑–∫–æ–≤."""
        if not self.controller.markers:
            QMessageBox.warning(self, "Warning", "No segments to preview")
            return

        from .preview_window import PreviewWindow
        self.preview_window = PreviewWindow(self.controller, self)
        self.preview_window.show()

    def _on_settings_clicked(self):
        """–û—Ç–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏."""
        dialog = SettingsDialog(self.controller, self)
        if dialog.exec():
            # –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏, –µ—Å–ª–∏ –æ–Ω–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
            self._rebind_hotkeys()

    def _on_export_clicked(self):
        """–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–∏–¥–µ–æ."""
        if not self.controller.markers:
            QMessageBox.warning(self, "Warning", "No segments to export")
            return

        from .export_dialog import ExportDialog
        dialog = ExportDialog(self.controller, self)
        dialog.exec()

    def _on_marker_double_clicked(self, item: QListWidgetItem):
        """–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –Ω–∞ –æ—Ç—Ä–µ–∑–æ–∫ = —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ."""
        idx = self.markers_list.row(item)
        dialog = SegmentEditorDialog(self.controller, idx, self)
        dialog.exec()

    def _on_delete_marker(self):
        """–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –æ—Ç—Ä–µ–∑–æ–∫."""
        current_idx = self.markers_list.currentRow()
        if current_idx >= 0:
            self.controller.delete_marker(current_idx)

    def _on_clear_markers(self):
        """–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ—Ç—Ä–µ–∑–∫–∏."""
        reply = QMessageBox.question(self, "Confirm", "Delete all segments?")
        if reply == QMessageBox.StandardButton.Yes:
            self.controller.clear_markers()

    def _on_playback_time_changed(self, frame_idx: int):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è."""
        fps = self.controller.get_fps()
        total_frames = self.controller.get_total_frames()

        self.progress_slider.blockSignals(True)
        self.progress_slider.setValue(frame_idx)
        self.progress_slider.blockSignals(False)

        # –û–±–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è
        if fps > 0:
            current_sec = frame_idx / fps
            total_sec = total_frames / fps
            self.time_label.setText(self._format_time(current_sec, total_sec))

        # –û–±–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å-–±–∞—Ä
        self._update_status_bar()

    def _on_markers_changed(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –æ—Ç—Ä–µ–∑–∫–æ–≤."""
        self.markers_list.clear()
        fps = self.controller.get_fps()

        for idx, marker in enumerate(self.controller.markers):
            start_time = self._format_time_single(marker.start_frame / fps if fps > 0 else 0)
            end_time = self._format_time_single(marker.end_frame / fps if fps > 0 else 0)
            text = f"{idx+1}. {marker.event_name} ({start_time}‚Äì{end_time})"
            self.markers_list.addItem(text)

        # –û–±–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å-–±–∞—Ä
        self._update_status_bar()

    def _on_recording_status_changed(self, event_type: str, status: str):
        """–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–ø–∏—Å–∏."""
        if status == "Recording":
            self.status_label.setText(f"üî¥ Recording: {event_type}")
            self.status_label.setStyleSheet("color: #ff0000;")
        elif status == "Complete":
            self.status_label.setText(f"‚úì Complete: {event_type}")
            self.status_label.setStyleSheet("color: #00ff00;")
        elif status == "Fixed":
            self.status_label.setText(f"‚úì Fixed: {event_type}")
            self.status_label.setStyleSheet("color: #00ff00;")
        elif status == "Cancelled":
            self.status_label.setText("‚èπÔ∏è Cancelled")
            self.status_label.setStyleSheet("color: #ffcc00;")
        else:
            self.status_label.setText("Ready")
            self.status_label.setStyleSheet("color: #ffcc00;")

    def _on_timeline_update(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–ª–∞–π–Ω–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ—Ä–µ–π–º–∞."""
        if hasattr(self.timeline_widget, 'scene_obj'):
            current_frame = self.controller.get_current_frame_idx()
            self.timeline_widget.scene_obj.update_playhead(current_frame)

    # –ò–°–ü–†–ê–í–õ–ï–ù–û: —É–¥–∞–ª–µ–Ω –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥ _setup_shortcuts —Å EventType

    def _on_events_changed(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π - –æ–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏ –∏ shortcuts."""
        self._update_event_buttons()
        self._setup_event_shortcuts()

    def _on_events_changed_timeline(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ç–∞–π–º–ª–∞–π–Ω–∞."""
        if hasattr(self.timeline_widget, 'scene_obj'):
            self.timeline_widget.scene_obj.update_scene()

    def _update_event_buttons(self):
        """–û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏ —Å–æ–±—ã—Ç–∏–π –Ω–∞ –æ—Å–Ω–æ–≤–µ CustomEventManager."""
        # –û—á–∏—Å—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–Ω–æ–ø–∫–∏
        for i in reversed(range(self.event_buttons_layout.count())):
            widget = self.event_buttons_layout.itemAt(i).widget()
            if widget:
                widget.setParent(None)

        # –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
        events = self.event_manager.get_all_events()
        for event in events:
            text = f"{event.shortcut.upper()}\n{event.name}"
            btn = self._create_event_button(text, event.color)
            btn.clicked.connect(lambda checked, e=event.name: self._on_event_btn_clicked(e))
            btn.setToolTip(f"Add {event.name} event ({event.shortcut.upper()})")
            self.event_buttons_layout.addWidget(btn)

    def _setup_shortcuts(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ —á–µ—Ä–µ–∑ ShortcutManager."""
        # –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ shortcuts –¥–ª—è —Å–æ–±—ã—Ç–∏–π (–µ—Å–ª–∏ –µ—Å—Ç—å)
        for event in self.event_manager.get_all_events():
            self.shortcut_manager.unregister_shortcut(event.name.upper())

        # –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å shortcuts –¥–ª—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
        self._setup_event_shortcuts()

        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å shortcuts –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
        self.shortcut_manager.register_shortcut('PLAY_PAUSE', 'Space', self._on_play_pause_clicked)
        self.shortcut_manager.register_shortcut('OPEN_VIDEO', 'Ctrl+O', self._on_open_video)
        self.shortcut_manager.register_shortcut('CANCEL', 'Escape', self._on_cancel_recording)
        self.shortcut_manager.register_shortcut('SETTINGS', 'Ctrl+,', self._on_settings_clicked)
        self.shortcut_manager.register_shortcut('EXPORT', 'Ctrl+E', self._on_export_clicked)
        self.shortcut_manager.register_shortcut('UNDO', 'Ctrl+Z', self._on_undo_clicked)
        self.shortcut_manager.register_shortcut('REDO', 'Ctrl+Shift+Z', self._on_redo_clicked)

    def _setup_event_shortcuts(self):
        """–°–æ–∑–¥–∞—ë—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ –¥–ª—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π."""
        # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
        if hasattr(self, '_event_shortcuts'):
            for s in self._event_shortcuts:
                s.activated.disconnect()
                s.setParent(None)
            self._event_shortcuts.clear()
        else:
            self._event_shortcuts = []

        for event in self.event_manager.get_all_events():
            if not event.shortcut:
                continue

            # –ü—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é!
            shortcut = QShortcut(QKeySequence(event.shortcut.upper()), self)
            shortcut.activated.connect(
                lambda checked=False, ev=event: self._on_event_hotkey_pressed(ev)
            )
            self._event_shortcuts.append(shortcut)

    def _rebind_hotkeys(self):
        """–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö."""
        # –ü–µ—Ä–µ—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ shortcuts
        self._setup_shortcuts()

    def _on_cancel_recording(self):
        """–û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏ (Escape)."""
        self.controller.cancel_recording()
        self._update_play_btn_text()

    def _on_event_hotkey_pressed(self, event):
        """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–∞–∂–∞—Ç–∏–µ –≥–æ—Ä—è—á–µ–π –∫–ª–∞–≤–∏—à–∏ —Å–æ–±—ã—Ç–∏—è."""
        current = self.controller.active_event

        if current and current.name == event.name:
            # –≠—Ç–æ –≤—Ç–æ—Ä–æ–µ –Ω–∞–∂–∞—Ç–∏–µ ‚Äî –∑–∞–≤–µ—Ä—à–∞–µ–º –æ—Ç—Ä–µ–∑–æ–∫
            self.controller.finish_recording()
            self._update_recording_indicator(None)
        else:
            # –ü–µ—Ä–≤–æ–µ –Ω–∞–∂–∞—Ç–∏–µ ‚Äî –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–∏—Å—å
            self.controller.start_recording(event)
            self._update_recording_indicator(event)

    def _update_recording_indicator(self, event):
        """–ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É –∏ —Å—Ç–∞—Ç—É—Å."""
        # –°–±—Ä–æ—Å –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
        for btn in self.event_buttons.values():
            btn.setStyleSheet("")

        if event:
            if event.name in self.event_buttons:
                self.event_buttons[event.name].setStyleSheet(
                    "background-color: #00ff00; color: black; font-weight: bold;"
                )
            self.statusBar().showMessage(f"–ó–ê–ü–ò–°–¨: {event.name} (–Ω–∞–∂–º–∏—Ç–µ {event.shortcut} —Å–Ω–æ–≤–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è)")
        else:
            self.statusBar().showMessage("–ì–æ—Ç–æ–≤")

    def _on_selection_changed(self) -> None:
        """Handle event selection change."""
        selected = self.event_list.selectedItems()
        has_selection = len(selected) > 0

        self.edit_btn.setEnabled(has_selection)

        # Can only delete non-default events
        if has_selection:
            event_name = selected[0].data(Qt.UserRole)
            event = self.manager.get_event(event_name)

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ None
            if event is None:
                self.delete_btn.setEnabled(False)
                return

            is_default = event.name in {e.name for e in self.manager.DEFAULT_EVENTS}
            self.delete_btn.setEnabled(has_selection and not is_default)
        else:
            self.delete_btn.setEnabled(False)

    def _update_video_frame(self):
        """–û–±–Ω–æ–≤–∏—Ç—å –≤–∏–¥–µ–æ –∫–∞–¥—Ä –Ω–∞ —ç–∫—Ä–∞–Ω–µ (—á–µ—Ä–µ–∑ —Å–∏–≥–Ω–∞–ª frame_ready)."""
        pass  # –í–∏–¥–µ–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ frame_ready —Å–∏–≥–Ω–∞–ª

    def _on_frame_ready(self, frame):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–æ—Ç–æ–≤–æ–≥–æ –∫–∞–¥—Ä–∞ –∏–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞."""
        if frame is None:
            return

        # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å BGR –≤ RGB
        import cv2
        frame_rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
        h, w, ch = frame_rgb.shape
        bytes_per_line = ch * w
        qt_image = QImage(frame_rgb.data, w, h, bytes_per_line, QImage.Format.Format_RGB888)

        # –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥ —Ä–∞–∑–º–µ—Ä label
        pixmap = QPixmap.fromImage(qt_image)
        pixmap = pixmap.scaledToWidth(800, Qt.TransformationMode.SmoothTransformation)
        self.video_label.setPixmap(pixmap)

    def _format_time(self, current_sec: float, total_sec: float) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º—è MM:SS / MM:SS."""
        def fmt(s):
            m = int(s) // 60
            s = int(s) % 60
            return f"{m:02d}:{s:02d}"
        return f"{fmt(current_sec)} / {fmt(total_sec)}"

    def _format_time_single(self, seconds: float) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º—è MM:SS."""
        minutes = int(seconds) // 60
        secs = int(seconds) % 60
        return f"{minutes:02d}:{secs:02d}"

    def _get_dark_stylesheet(self) -> str:
        """–¢—ë–º–Ω—ã–π —Å—Ç–∏–ª—å."""
        return """
        QMainWindow, QWidget {
            background-color: #1a1a1a;
            color: #ffffff;
        }
        QPushButton {
            background-color: #333333;
            color: white;
            border: 1px solid #555555;
            padding: 5px;
            border-radius: 3px;
        }
        QPushButton:hover {
            background-color: #444444;
        }
        QSlider::groove:horizontal {
            background: #333333;
            height: 6px;
            border-radius: 3px;
        }
        QSlider::handle:horizontal {
            background: #ffcc00;
            width: 14px;
            margin: -4px 0;
            border-radius: 7px;
        }
        QListWidget {
            background-color: #2a2a2a;
            color: #ffffff;
            border: 1px solid #555555;
        }
        QLabel {
            color: #ffffff;
        }
        QComboBox {
            background-color: #333333;
            color: #ffffff;
            border: 1px solid #555555;
        }
        """

    # ===== MENU HANDLERS =====

    def _on_new_project(self):
        """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç."""
        self.controller.markers.clear()
        self.controller.markers_changed.emit()
        QMessageBox.information(self, "New Project", "Project cleared")

    def _on_open_project(self):
        """–û—Ç–∫—Ä—ã—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç."""
        path, _ = QFileDialog.getOpenFileName(
            self, "Open Project", "", "Hockey Editor Projects (*.hep);;All Files (*)"
        )

        if path:
            if self.controller.load_project(path):
                QMessageBox.information(self, "Success", f"Project loaded: {path}")
            else:
                QMessageBox.critical(self, "Error", f"Failed to load project: {path}")

    def _on_save_project(self):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç."""
        if not hasattr(self, 'current_project_path') or not self.current_project_path:
            self._on_save_project_as()
        else:
            if self.controller.save_project(self.current_project_path):
                QMessageBox.information(self, "Success", "Project saved")
            else:
                QMessageBox.critical(self, "Error", "Failed to save project")

    def _on_save_project_as(self):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç –∫–∞–∫ –Ω–æ–≤—ã–π —Ñ–∞–π–ª."""
        path, _ = QFileDialog.getSaveFileName(
            self, "Save Project As", "", "Hockey Editor Projects (*.hep);;All Files (*)"
        )

        if path:
            if self.controller.save_project(path):
                self.current_project_path = path
                self.setWindowTitle(f"Hockey Editor Pro - {Path(path).name}")
                QMessageBox.information(self, "Success", "Project saved")
            else:
                QMessageBox.critical(self, "Error", "Failed to save project")

    def _update_recent_menu(self):
        """–û–±–Ω–æ–≤–∏—Ç—å –º–µ–Ω—é –Ω–µ–¥–∞–≤–Ω–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤."""
        self.recent_menu.clear()

        recent_projects = self.controller.get_recent_projects()
        if not recent_projects:
            self.recent_menu.addAction("(No recent projects)")
            return

        for path in recent_projects:
            action = self.recent_menu.addAction(Path(path).name)
            action.triggered.connect(lambda checked, p=path: self._on_recent_project(p))

    def _on_recent_project(self, path: str):
        """–û—Ç–∫—Ä—ã—Ç—å –Ω–µ–¥–∞–≤–Ω–∏–π –ø—Ä–æ–µ–∫—Ç."""
        if self.controller.load_project(path):
            QMessageBox.information(self, "Success", f"Project loaded: {path}")
            self._update_recent_menu()
        else:
            QMessageBox.critical(self, "Error", f"Failed to load project: {path}")

    def _on_about(self):
        """–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏."""
        QMessageBox.information(
            self, "About Hockey Editor Pro",
            "Hockey Editor Pro v1.0\n"
            "Professional Video Analysis Tool\n\n"
            "Hotkeys:\n"
            "A - Attack\n"
            "D - Defense\n"
            "S - Shift\n"
            "Space - Play/Pause\n"
            "Ctrl+O - Open Video\n"
            "Ctrl+E - Export\n"
            "Ctrl+, - Settings"
        )

    def _on_autosave_completed(self, success: bool, message: str):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è."""
        if success:
            self.status_label.setText(f"‚úì {message}")
        else:
            print(f"Autosave error: {message}")

    def dragEnterEvent(self, event):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–∞ drag-drop."""
        if event.mimeData().hasUrls():
            event.acceptProposedAction()

    def dropEvent(self, event):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ drop –≤–∏–¥–µ–æ—Ñ–∞–π–ª–∞."""
        for url in event.mimeData().urls():
            file_path = url.toLocalFile()
            if file_path.lower().endswith(('.mp4', '.avi', '.mov', '.mkv', '.flv', '.wmv')):
                self.controller.load_video(file_path)
                break

    def open_segment_editor(self, marker_idx: int):
        """–û—Ç–∫—Ä—ã—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä —Å–µ–≥–º–µ–Ω—Ç–∞ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ timeline –ø—Ä–∏ double-click)."""
        if 0 <= marker_idx < len(self.controller.markers):
            dialog = SegmentEditorDialog(self.controller, marker_idx, self)
            dialog.exec()

    def _update_status_bar(self):
        """–û–±–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å-–±–∞—Ä —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π."""
        fps = self.controller.get_fps()
        current_frame = self.controller.get_current_frame_idx()
        total_frames = self.controller.get_total_frames()

        if fps > 0 and total_frames > 0:
            current_time = self._format_time_single(current_frame / fps)
            total_time = self._format_time_single(total_frames / fps)
            segment_count = len(self.controller.markers)

            status = f"{current_time}/{total_time} | {segment_count} segments | FPS: {fps:.2f}"

            # –ï—Å–ª–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ, –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
            if self.controller.playing:
                status = "‚ñ∂ " + status

            self.status_label.setText(status)
        else:
            self.status_label.setText("Ready")

    def closeEvent(self, event):
        """–ó–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞."""
        self.autosave_manager.stop()
        self.controller.cleanup()
        event.accept()
```

### 6. utils/custom_events.py - –ú–µ–Ω–µ–¥–∂–µ—Ä –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π

```python
"""
Custom event types manager for user-defined event categories.

Allows users to define their own event types (Attack, Defense, Shift, etc.)
with custom names and colors. Events are stored in QSettings and used
throughout the application for marker categorization.
"""

from typing import Dict, List, Optional
from dataclasses import dataclass
from PySide6.QtCore import Signal, QObject
from PySide6.QtGui import QColor
from .settings_manager import get_settings_manager


@dataclass
class CustomEventType:
    """Represents a custom event type with metadata."""

    name: str
    color: str  # Hex color (e.g., "#FF0000")
    shortcut: str = ""  # Keyboard shortcut (e.g., "A", "Ctrl+X")
    description: str = ""

    def to_dict(self) -> Dict:
        """Convert to dictionary for serialization."""
        return {
            'name': self.name,
            'color': self.color,
            'shortcut': self.shortcut,
            'description': self.description
        }

    @classmethod
    def from_dict(cls, data: Dict) -> 'CustomEventType':
        """Create from dictionary (deserialization)."""
        return cls(
            name=data.get('name', ''),
            color=data.get('color', '#CCCCCC'),
            shortcut=data.get('shortcut', ''),
            description=data.get('description', '')
        )

    def get_qcolor(self) -> QColor:
        """Get Qt color object."""
        color = QColor(self.color)
        return color if color.isValid() else QColor('#CCCCCC')


class CustomEventManager(QObject):
    """Manages user-defined event types with persistence."""

    # –°–∏–≥–Ω–∞–ª –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏–π - –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
    events_changed = Signal()

    # Default event types (always available)
    DEFAULT_EVENTS = [
        CustomEventType(name='Attack', color='#EF5350', shortcut='A', description='Offensive play'),
        CustomEventType(name='Defense', color='#42A5F5', shortcut='D', description='Defensive play'),
        CustomEventType(name='Shift', color='#66BB6A', shortcut='S', description='Line change/shift'),
    ]

    def __init__(self):
        """Initialize manager and load settings."""
        super().__init__()  # Initialize QObject base class
        self.settings = get_settings_manager()
        self._custom_events: Dict[str, CustomEventType] = {}
        self._load_events()

    def _load_events(self) -> None:
        """Load custom events from settings."""
        events_data = self.settings.load_custom_events()
        self._custom_events = {}

        # Load from settings
        for event_dict in events_data:
            event = CustomEventType.from_dict(event_dict)
            self._custom_events[event.name] = event

        # Ensure defaults exist (in case not in settings)
        for default_event in self.DEFAULT_EVENTS:
            if default_event.name not in self._custom_events:
                self._custom_events[default_event.name] = default_event

    def get_all_events(self) -> List[CustomEventType]:
        """Get all event types (sorted by name)."""
        return sorted(self._custom_events.values(), key=lambda e: e.name)

    def get_event(self, name: str) -> Optional[CustomEventType]:
        """Get specific event type by name."""
        return self._custom_events.get(name)

    def add_event(self, event: CustomEventType) -> bool:
        """Add new custom event. Returns False if name already exists."""
        if event.name in self._custom_events:
            return False

        # Validate color
        if not event.get_qcolor().isValid():
            return False

        self._custom_events[event.name] = event
        self._save_events()
        return True

    def update_event(self, old_name: str, new_event: CustomEventType) -> bool:
        """Update existing event. Returns False if new name already exists (and differs from old)."""
        if old_name not in self._custom_events:
            return False

        # Check if trying to rename to existing name
        if old_name != new_event.name and new_event.name in self._custom_events:
            return False

        # Validate color
        if not new_event.get_qcolor().isValid():
            return False

        # Remove old entry if renaming
        if old_name != new_event.name:
            del self._custom_events[old_name]

        self._custom_events[new_event.name] = new_event
        self._save_events()
        return True

    def delete_event(self, name: str) -> bool:
        """Delete custom event. Cannot delete default events."""
        if name not in self._custom_events:
            return False

        # Protect default events
        default_names = {e.name for e in self.DEFAULT_EVENTS}
        if name in default_names:
            return False

        del self._custom_events[name]
        self._save_events()
        return True

    def reset_to_defaults(self) -> None:
        """Reset all events to defaults."""
        self._custom_events = {e.name: e for e in self.DEFAULT_EVENTS}
        self._save_events()

    def _save_events(self) -> None:
        """Save custom events to settings."""
        events_data = [event.to_dict() for event in self.get_all_events()]
        self.settings.save_custom_events(events_data)
        self.events_changed.emit()  # –£–≤–µ–¥–æ–º–∏—Ç—å UI –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

    def get_event_by_hotkey(self, hotkey: str) -> Optional[CustomEventType]:
        """Get event by keyboard shortcut."""
        for event in self._custom_events.values():
            if event.shortcut.upper() == hotkey.upper():
                return event
        return None

    def get_event_color(self, name: str) -> QColor:
        """Get color for event type (or gray if not found)."""
        event = self.get_event(name)
        if event:
            return event.get_qcolor()
        return QColor('#CCCCCC')  # Gray fallback

    def get_event_hotkey(self, name: str) -> str:
        """Get keyboard shortcut for event type."""
        event = self.get_event(name)
        return event.shortcut if event else ""


# Global instance
_manager: Optional[CustomEventManager] = None


def get_custom_event_manager() -> CustomEventManager:
    """Get or create global CustomEventManager instance."""
    global _manager
    if _manager is None:
        _manager = CustomEventManager()
    return _manager


def reset_custom_event_manager() -> None:
    """Reset global manager (for testing)."""
    global _manager
    _manager = None
```

### 7. utils/settings_manager.py - –ú–µ–Ω–µ–¥–∂–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫

```python
class SettingsManager:
    """
    –ú–µ–Ω–µ–¥–∂–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º QSettings.
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º —Ä–µ–µ—Å—Ç—Ä–µ/–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö.
    """

    def __init__(self):
        from PySide6.QtCore import QSettings
        self.settings = QSettings("HockeyEditor", "HockeyEditorPro")

    # ===== –†–ï–ñ–ò–ú –†–ê–°–°–¢–ê–ù–û–í–ö–ò –û–¢–†–ï–ó–ö–û–í =====

    def load_recording_mode(self) -> str:
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∂–∏–º —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ç—Ä–µ–∑–∫–æ–≤."""
        return self.settings.value("recording_mode", "dynamic")

    def save_recording_mode(self, mode: str):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∂–∏–º —Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ç—Ä–µ–∑–∫–æ–≤."""
        self.settings.setValue("recording_mode", mode)

    def load_fixed_duration(self) -> int:
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –¥–ª–∏–Ω—É –æ—Ç—Ä–µ–∑–∫–∞ (—Å–µ–∫—É–Ω–¥—ã)."""
        return int(self.settings.value("fixed_duration", 5))

    def save_fixed_duration(self, seconds: int):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é –¥–ª–∏–Ω—É –æ—Ç—Ä–µ–∑–∫–∞."""
        self.settings.setValue("fixed_duration", seconds)

    def load_pre_roll(self) -> float:
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç–∫–∞—Ç –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –æ—Ç—Ä–µ–∑–∫–∞ (—Å–µ–∫—É–Ω–¥—ã)."""
        return float(self.settings.value("pre_roll", 3.0))

    def save_pre_roll(self, seconds: float):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–∫–∞—Ç –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –æ—Ç—Ä–µ–∑–∫–∞."""
        self.settings.setValue("pre_roll", seconds)

    def load_post_roll(self) -> float:
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ–Ω–µ—Ü –æ—Ç—Ä–µ–∑–∫–∞ (—Å–µ–∫—É–Ω–¥—ã)."""
        return float(self.settings.value("post_roll", 0.0))

    def save_post_roll(self, seconds: float):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ–Ω–µ—Ü –æ—Ç—Ä–µ–∑–∫–∞."""
        self.settings.setValue("post_roll", seconds)

    # ===== –ö–ê–°–¢–û–ú–ù–´–ï –°–û–ë–´–¢–ò–Ø =====

    def load_custom_events(self) -> list:
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π."""
        events_json = self.settings.value("custom_events", "[]")
        try:
            import json
            return json.loads(events_json)
        except (json.JSONDecodeError, TypeError):
            return []

    def save_custom_events(self, events_data: list):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π."""
        import json
        self.settings.setValue("custom_events", json.dumps(events_data))

    # ===== –ù–ï–î–ê–í–ù–ò–ï –ü–†–û–ï–ö–¢–´ =====

    def load_recent_projects(self) -> list:
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–µ–¥–∞–≤–Ω–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤."""
        projects_json = self.settings.value("recent_projects", "[]")
        try:
            import json
            return json.loads(projects_json)
        except (json.JSONDecodeError, TypeError):
            return []

    def save_recent_projects(self, projects: list):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–µ–¥–∞–≤–Ω–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤."""
        import json
        self.settings.setValue("recent_projects", json.dumps(projects))

    # ===== –ù–ê–°–¢–†–û–ô–ö–ò –≠–ö–°–ü–û–†–¢–ê =====

    def load_export_format(self) -> str:
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞."""
        return self.settings.value("export_format", "mp4")

    def save_export_format(self, format: str):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç —ç–∫—Å–ø–æ—Ä—Ç–∞."""
        self.settings.setValue("export_format", format)

    def load_export_quality(self) -> str:
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ —ç–∫—Å–ø–æ—Ä—Ç–∞."""
        return self.settings.value("export_quality", "high")

    def save_export_quality(self, quality: str):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ —ç–∫—Å–ø–æ—Ä—Ç–∞."""
        self.settings.setValue("export_quality", quality)

    # ===== –ù–ê–°–¢–†–û–ô–ö–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê =====

    def load_theme(self) -> str:
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–º—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞."""
        return self.settings.value("theme", "dark")

    def save_theme(self, theme: str):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–º—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞."""
        self.settings.setValue("theme", theme)

    def load_window_geometry(self) -> bytes:
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å –≥–µ–æ–º–µ—Ç—Ä–∏—é –æ–∫–Ω–∞."""
        return self.settings.value("window_geometry", b"")

    def save_window_geometry(self, geometry: bytes):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≥–µ–æ–º–µ—Ç—Ä–∏—é –æ–∫–Ω–∞."""
        self.settings.setValue("window_geometry", geometry)

    def load_window_state(self) -> bytes:
        """–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∫–Ω–∞."""
        return self.settings.value("window_state", b"")

    def save_window_state(self, state: bytes):
        """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∫–Ω–∞."""
        self.settings.setValue("window_state", state)


# Global instance
_settings_manager = None


def get_settings_manager() -> SettingsManager:
    """–ü–æ–ª—É—á–∏—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä SettingsManager."""
    global _settings_manager
    if _settings_manager is None:
        _settings_manager = SettingsManager()
    return _settings_manager
```

### 8. utils/undo_redo.py - –°–∏—Å—Ç–µ–º–∞ –æ—Ç–º–µ–Ω—ã/–ø–æ–≤—Ç–æ—Ä–∞ –æ–ø–µ—Ä–∞—Ü–∏–π

```python
from PySide6.QtCore import QObject
from typing import List, Any
from abc import ABC, abstractmethod


class QUndoCommand(ABC):
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –∫–æ–º–∞–Ω–¥ undo/redo."""

    def __init__(self):
        self.description = ""

    @abstractmethod
    def undo(self):
        """–û—Ç–º–µ–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é."""
        pass

    @abstractmethod
    def redo(self):
        """–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é."""
        pass


class MarkerCommand(QUndoCommand):
    """–ë–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å –¥–ª—è –∫–æ–º–∞–Ω–¥ –æ–ø–µ—Ä–∞—Ü–∏–π —Å –º–∞—Ä–∫–µ—Ä–∞–º–∏."""

    def __init__(self, markers_list: List):
        super().__init__()
        self.markers = markers_list


class AddMarkerCommand(MarkerCommand):
    """–ö–æ–º–∞–Ω–¥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞."""

    def __init__(self, markers_list: List, marker):
        super().__init__(markers_list)
        self.marker = marker
        self.description = f"Add {marker.event_name} marker"

    def undo(self):
        """–£–¥–∞–ª–∏—Ç—å –º–∞—Ä–∫–µ—Ä."""
        if self.marker in self.markers:
            self.markers.remove(self.marker)

    def redo(self):
        """–î–æ–±–∞–≤–∏—Ç—å –º–∞—Ä–∫–µ—Ä."""
        if self.marker not in self.markers:
            self.markers.append(self.marker)


class DeleteMarkerCommand(MarkerCommand):
    """–ö–æ–º–∞–Ω–¥–∞ —É–¥–∞–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞."""

    def __init__(self, markers_list: List, index: int):
        super().__init__(markers_list)
        self.index = index
        if 0 <= index < len(markers_list):
            self.marker = markers_list[index]
            self.description = f"Delete {self.marker.event_name} marker"
        else:
            self.marker = None

    def undo(self):
        """–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∞—Ä–∫–µ—Ä."""
        if self.marker and self.marker not in self.markers:
            self.markers.insert(self.index, self.marker)

    def redo(self):
        """–£–¥–∞–ª–∏—Ç—å –º–∞—Ä–∫–µ—Ä."""
        if self.marker and self.marker in self.markers:
            self.markers.remove(self.marker)


class ModifyMarkerCommand(MarkerCommand):
    """–ö–æ–º–∞–Ω–¥–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞."""

    def __init__(self, markers_list: List, index: int, old_marker, new_marker):
        super().__init__(markers_list)
        self.index = index
        self.old_marker = old_marker
        self.new_marker = new_marker
        self.description = f"Modify {old_marker.event_name} marker"

    def undo(self):
        """–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä."""
        if 0 <= self.index < len(self.markers):
            self.markers[self.index] = self.old_marker

    def redo(self):
        """–ü—Ä–∏–º–µ–Ω–∏—Ç—å –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä."""
        if 0 <= self.index < len(self.markers):
            self.markers[self.index] = self.new_marker


class ClearMarkersCommand(MarkerCommand):
    """–ö–æ–º–∞–Ω–¥–∞ –æ—á–∏—Å—Ç–∫–∏ –≤—Å–µ—Ö –º–∞—Ä–∫–µ—Ä–æ–≤."""

    def __init__(self, markers_list: List):
        super().__init__(markers_list)
        self.saved_markers = markers_list.copy()
        self.description = "Clear all markers"

    def undo(self):
        """–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã."""
        self.markers.clear()
        self.markers.extend(self.saved_markers)

    def redo(self):
        """–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã."""
        self.markers.clear()


class UndoRedoManager(QObject):
    """–ú–µ–Ω–µ–¥–∂–µ—Ä undo/redo –æ–ø–µ—Ä–∞—Ü–∏–π."""

    def __init__(self, max_history: int = 50):
        super().__init__()
        self.history: List[QUndoCommand] = []
        self.current_index = -1
        self.max_history = max_history

    def push_command(self, command: QUndoCommand):
        """–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –≤ –∏—Å—Ç–æ—Ä–∏—é."""
        # –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã –ø–æ—Å–ª–µ —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏
        self.history = self.history[:self.current_index + 1]

        # –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É
        self.history.append(command)
        self.current_index += 1

        # –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
        if len(self.history) > self.max_history:
            self.history.pop(0)
            self.current_index -= 1

    def undo(self):
        """–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –æ–ø–µ—Ä–∞—Ü–∏—é."""
        if self.can_undo():
            command = self.history[self.current_index]
            command.undo()
            self.current_index -= 1

    def redo(self):
        """–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –æ—Ç–º–µ–Ω—ë–Ω–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é."""
        if self.can_redo():
            self.current_index += 1
            command = self.history[self.current_index]
            command.redo()

    def can_undo(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –º–æ–∂–Ω–æ –ª–∏ –æ—Ç–º–µ–Ω–∏—Ç—å."""
        return self.current_index >= 0

    def can_redo(self) -> bool:
        """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –º–æ–∂–Ω–æ –ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å."""
        return self.current_index < len(self.history) - 1

    def clear_history(self):
        """–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∫–æ–º–∞–Ω–¥."""
        self.history.clear()
        self.current_index = -1

    def get_undo_description(self) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –æ—Ç–º–µ–Ω—ã."""
        if self.can_undo():
            return self.history[self.current_index].description
        return ""

    def get_redo_description(self) -> str:
        """–ü–æ–ª—É—á–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞."""
        if self.can_redo():
            return self.history[self.current_index + 1].description
        return ""
```

### 9. ui/timeline_graphics.py - –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Ç–∞–π–º–ª–∞–π–Ω–∞

```python
from PySide6.QtWidgets import QGraphicsRectItem, QGraphicsLineItem, QGraphicsScene, QGraphicsView, QGraphicsTextItem
from PySide6.QtCore import Qt, QRectF, QPointF, pyqtSignal
from PySide6.QtGui import QPen, QBrush, QColor, QFont
from typing import List, Optional
import math


class SegmentGraphicsItem(QGraphicsRectItem):
    """–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç –Ω–∞ —Ç–∞–π–º–ª–∞–π–Ω–µ."""

    def __init__(self, marker, timeline_scene):
        super().__init__()
        self.marker = marker
        self.timeline_scene = timeline_scene
        self.setAcceptHoverEvents(True)
        self.setFlags(QGraphicsRectItem.ItemIsSelectable)

        # –¶–≤–µ—Ç —Å–µ–≥–º–µ–Ω—Ç–∞
        from ..utils.custom_events import get_custom_event_manager
        event_manager = get_custom_event_manager()
        event = event_manager.get_event(marker.event_name)
        if event:
            color = QColor(event.color)
        else:
            color = QColor('#CCCCCC')

        # –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –±–µ–ª—ã–π –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤
        self.setBrush(QBrush(QColor(255, 255, 255, 180)))
        self.setPen(QPen(color, 2))

        # –¢–µ–∫—Å—Ç —Å –∏–º–µ–Ω–µ–º —Å–æ–±—ã—Ç–∏—è
        self.text_item = QGraphicsTextItem(marker.event_name, self)
        self.text_item.setDefaultTextColor(color)
        font = QFont("Arial", 8)
        self.text_item.setFont(font)

        # –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
        self.update_text_position()

    def update_text_position(self):
        """–û–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é —Ç–µ–∫—Å—Ç–∞."""
        rect = self.rect()
        text_rect = self.text_item.boundingRect()
        center_x = rect.center().x() - text_rect.width() / 2
        center_y = rect.center().y() - text_rect.height() / 2
        self.text_item.setPos(center_x, center_y)

    def hoverEnterEvent(self, event):
        """–ù–∞–≤–µ–¥–µ–Ω–∏–µ –º—ã—à–∏."""
        self.setPen(QPen(self.pen().color(), 3))
        super().hoverEnterEvent(event)

    def hoverLeaveEvent(self, event):
        """–£—Ö–æ–¥ –º—ã—à–∏."""
        self.setPen(QPen(self.pen().color(), 2))
        super().hoverLeaveEvent(event)

    def mouseDoubleClickEvent(self, event):
        """–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ - —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–∞."""
        if self.timeline_scene.main_window:
            # –ù–∞–π—Ç–∏ –∏–Ω–¥–µ–∫—Å –º–∞—Ä–∫–µ—Ä–∞
            try:
                idx = self.timeline_scene.controller.markers.index(self.marker)
                self.timeline_scene.main_window.open_segment_editor(idx)
            except ValueError:
                pass
        super().mouseDoubleClickEvent(event)


class PlayheadGraphicsItem(QGraphicsLineItem):
    """–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è."""

    def __init__(self):
        super().__init__()
        self.setPen(QPen(QColor('#FFFF00'), 3))  # –ñ—ë–ª—Ç—ã–π playhead
        self.setZValue(100)  # –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ


class TimelineGraphicsScene(QGraphicsScene):
    """QGraphicsScene –¥–ª—è —Ç–∞–π–º–ª–∞–π–Ω–∞ —Å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º."""

    def __init__(self, controller):
        super().__init__()
        self.controller = controller
        self.main_window = None  # Set by main window

        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        self.track_height = 50
        self.header_height = 30
        self.pixels_per_frame = 0.5  # –ù–∞—á–∞–ª—å–Ω—ã–π –º–∞—Å—à—Ç–∞–±

        # –≠–ª–µ–º–µ–Ω—Ç—ã
        self.playhead = PlayheadGraphicsItem()
        self.addItem(self.playhead)

        # –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–æ—Ä–æ–∂–µ–∫
        self.track_headers = []

        self.update_scene()

    def update_scene(self):
        """–û–±–Ω–æ–≤–∏—Ç—å –≤—Å—é —Å—Ü–µ–Ω—É."""
        self.clear()
        self.addItem(self.playhead)

        # –ü–æ–ª—É—á–∏—Ç—å —Å–æ–±—ã—Ç–∏—è
        from ..utils.custom_events import get_custom_event_manager
        event_manager = get_custom_event_manager()
        events = event_manager.get_all_events()

        # –°–æ–∑–¥–∞—Ç—å –¥–æ—Ä–æ–∂–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏–π
        for track_idx, event in enumerate(events):
            y_pos = self.header_height + track_idx * self.track_height

            # –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–æ—Ä–æ–∂–∫–∏
            header = self.addRect(0, track_idx * self.track_height,
                                100, self.header_height,
                                QPen(Qt.black), QBrush(QColor(event.color)))
            header_text = self.addText(event.name)
            header_text.setPos(5, track_idx * self.track_height + 5)
            header_text.setDefaultTextColor(Qt.white)

            # –°–µ–≥–º–µ–Ω—Ç—ã –Ω–∞ —ç—Ç–æ–π –¥–æ—Ä–æ–∂–∫–µ
            for marker in self.controller.markers:
                if marker.event_name == event.name:
                    x = marker.start_frame * self.pixels_per_frame
                    width = (marker.end_frame - marker.start_frame) * self.pixels_per_frame
                    height = self.track_height - 5

                    segment = SegmentGraphicsItem(marker, self)
                    segment.setRect(x, y_pos + 2.5, width, height)
                    self.addItem(segment)

        # –û–±–Ω–æ–≤–∏—Ç—å playhead
        self.update_playhead(self.controller.get_current_frame_idx())

    def update_playhead(self, frame_idx: int):
        """–û–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é playhead."""
        x = frame_idx * self.pixels_per_frame
        scene_height = len(self.controller.markers) * self.track_height + self.header_height
        self.playhead.setLine(x, 0, x, scene_height)

    def frame_to_scene_x(self, frame_idx: int) -> float:
        """–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å –∫–∞–¥—Ä–∞ –≤ X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É —Å—Ü–µ–Ω—ã."""
        return frame_idx * self.pixels_per_frame

    def scene_x_to_frame(self, x: float) -> int:
        """–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å X –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—É —Å—Ü–µ–Ω—ã –≤ –∏–Ω–¥–µ–∫—Å –∫–∞–¥—Ä–∞."""
        return int(x / self.pixels_per_frame)


class TimelineGraphicsView(QGraphicsView):
    """QGraphicsView –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–π–º–ª–∞–π–Ω–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è."""

    def __init__(self):
        super().__init__()
        self.scene_obj = None
        self.main_window = None  # Set by main window
        self.controller = None

        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        self.setRenderHint(self.renderHints() | self.RenderHint.Antialiasing)
        self.setViewportUpdateMode(self.ViewportUpdateMode.FullViewportUpdate)
        self.setHorizontalScrollBarPolicy(Qt.ScrollBarPolicy.ScrollBarAlwaysOn)
        self.setVerticalScrollBarPolicy(Qt.ScrollBarPolicy.ScrollBarAlwaysOff)

        # –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–µ—Å–æ–º –º—ã—à–∏
        self.setTransformationAnchor(self.ViewportAnchor.AnchorUnderMouse)
        self.scale_factor = 1.0

    def set_controller(self, controller):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä."""
        self.controller = controller
        self.scene_obj = TimelineGraphicsScene(controller)
        self.scene_obj.main_window = self.main_window
        self.setScene(self.scene_obj)

    def wheelEvent(self, event):
        """–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–µ—Å–æ–º –º—ã—à–∏ —Å Ctrl."""
        if event.modifiers() & Qt.KeyboardModifier.ControlModifier:
            zoom_factor = 1.2
            if event.angleDelta().y() > 0:
                # –ü—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ
                self.scale(zoom_factor, 1.0)
                self.scene_obj.pixels_per_frame *= zoom_factor
                self.scale_factor *= zoom_factor
            else:
                # –û—Ç–¥–∞–ª–µ–Ω–∏–µ
                self.scale(1.0 / zoom_factor, 1.0)
                self.scene_obj.pixels_per_frame /= zoom_factor
                self.scale_factor /= zoom_factor

            # –û–±–Ω–æ–≤–∏—Ç—å —Å—Ü–µ–Ω—É
            self.scene_obj.update_scene()
        else:
            # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞
            super().wheelEvent(event)

    def mousePressEvent(self, event):
        """–ö–ª–∏–∫ –¥–ª—è seek."""
        if event.button() == Qt.MouseButton.LeftButton:
            scene_pos = self.mapToScene(event.pos())
            frame_idx = self.scene_obj.scene_x_to_frame(scene_pos.x())

            # –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–º–∫–∞–º–∏ –≤–∏–¥–µ–æ
            total_frames = self.controller.get_total_frames()
            frame_idx = max(0, min(frame_idx, total_frames - 1))

            self.controller.seek_frame(frame_idx)

        super().mousePressEvent(event)
```
