# Структура проекта Hockey Editor

## Обзор проекта

**Hockey Editor** - профессиональный инструмент для покадрового анализа хоккейных матчей с поддержкой 13 типов игровых событий и возможностью создания собственных категорий.

### Основные возможности
- Видеоплеер с управлением воспроизведением и перемоткой
- Маркеры событий с горячими клавишами
- Интерактивный таймлайн с цветными дорожками
- Предпросмотр и фильтрация отмеченных сегментов
- Экспорт сегментов в видео форматы
- Система проектов с сохранением/загрузкой
- Undo/Redo операций
- Настраиваемые типы событий

## Архитектура приложения

### Общая структура

```
hockey_editor/
├── main.py                 # Точка входа приложения
├── core/                   # Бизнес-логика
├── ui/                     # Пользовательский интерфейс
├── models/                 # Модели данных
├── utils/                  # Утилиты и вспомогательные классы
└── __init__.py
```

## Детальное описание модулей

### 1. Core Module (Бизнес-логика)

#### `core/video_controller.py`
**Основной контроллер приложения**

**Классы:**
- `VideoController` - главный контроллер видео с синхронизацией воспроизведения
- `RecordingMode` - enum режимов расстановки отрезков

**Ответственность:**
- Управление воспроизведением видео
- Обработка горячих клавиш событий
- Управление маркерами (создание, удаление, модификация)
- Undo/Redo операций
- Управление скоростью воспроизведения
- Сохранение и загрузка проектов

**Ключевые методы:**
- `load_video()` - загрузка видеофайла
- `play()`, `pause()`, `seek_frame()` - управление воспроизведением
- `on_hotkey_pressed()` - обработка нажатий горячих клавиш
- `save_project()`, `load_project()` - работа с проектами
- `undo()`, `redo()` - операции отмены/повтора

#### `core/video_processor.py`
**Обработка видео через OpenCV**

**Классы:**
- `VideoProcessor` - управление видео через cv2.VideoCapture

**Ответственность:**
- Загрузка и управление видеофайлами
- Получение кадров по индексам
- Информация о видео (FPS, количество кадров, разрешение)
- Буферизация текущего кадра

#### `core/event_creation_controller.py`
**Контроллер создания событий**

**Классы:**
- `EventCreationController` - контроллер создания событий (отрезков)
- `RecordingMode` - enum режимов расстановки отрезков

**Ответственность:**
- Управление процессом создания маркеров событий
- Поддержка разных режимов записи (динамический, фиксированной длины)
- Обработка pre-roll и post-roll настроек
- Управление состоянием записи

#### `core/project_manager.py`
**Управление проектами**

**Классы:**
- `Project` - модель данных проекта
- `ProjectManager` - менеджер проектов

**Ответственность:**
- Сериализация/десериализация проектов в формате HEP (ZIP)
- Управление списком недавних проектов
- Валидация и восстановление проектов

#### `core/exporter.py`
**Экспорт видео**

**Классы:**
- `VideoExporter` - экспортер видео сегментов

**Ответственность:**
- Экспорт выделенных сегментов в видео файлы
- Поддержка различных форматов и кодеков
- Прогресс-бары и обработка ошибок

#### `core/video_reader_thread.py`
**Фоновая загрузка видео**

**Классы:**
- `VideoReaderThread` - поток для чтения видео

**Ответственность:**
- Асинхронная загрузка видео без блокировки UI
- Буферизация кадров для плавного воспроизведения

### 2. UI Module (Пользовательский интерфейс)

#### `ui/main_window.py`
**Главное окно приложения**

**Классы:**
- `MainWindow` - главное окно приложения

**Ответственность:**
- Основной контейнер UI компонентов
- Обработка меню и горячих клавиш
- Управление окнами диалогов
- Интеграция всех UI компонентов
- Drag & drop для видео файлов

**Ключевые компоненты:**
- Видео плеер с элементами управления
- Таймлайн с интерактивными элементами
- Список сегментов с фильтрами
- Панель горячих клавиш событий
- Статус-бар с информацией

#### `ui/timeline_graphics.py`
**Графический таймлайн**

**Классы:**
- `TimelineGraphicsView` - кастомный QGraphicsView
- `TimelineScrollArea` - кастомный QScrollArea
- `SegmentGraphicsItem` - элемент сегмента на таймлайне
- `TrackHeaderItem` - заголовок трека события
- `TimelineGraphicsScene` - основная сцена таймлайна
- `TimelineWidget` - виджет-контейнер таймлайна

**Ответственность:**
- Визуализация таймлайна с цветными дорожками
- Интерактивные элементы управления
- Масштабирование и навигация
- Отображение плейхэда и маркеров времени

#### `ui/player_controls.py`
**Панель управления плеером**

**Классы:**
- `PlayerControls` - профессиональная панель управления видео

**Ответственность:**
- Кнопки Play/Pause/Stop
- Ползунок прогресса
- Отображение времени и длительности
- Управление скоростью воспроизведения
- Кнопки перемотки

#### `ui/preview_window.py`
**Окно предпросмотра сегментов**

**Классы:**
- `EventCard` - карточка события с информацией
- `PreviewWindow` - окно предпросмотра

**Ответственность:**
- Просмотр всех отмеченных сегментов
- Фильтрация по типам событий
- Навигация между сегментами

#### `ui/instance_edit_window.py`
**Редактор сегментов**

**Классы:**
- `VisualTimeline` - визуальный таймлайн для редактирования
- `InstanceEditWindow` - окно редактирования сегмента

**Ответственность:**
- Редактирование границ сегментов
- Изменение типа события и заметок
- Визуальная настройка тайминга

#### `ui/export_dialog.py`
**Диалог экспорта**

**Классы:**
- `ExportWorker` - worker thread для экспорта
- `ExportDialog` - диалог экспорта видео

**Ответственность:**
- Выбор сегментов для экспорта
- Настройка параметров экспорта
- Прогресс-бар и статус экспорта

#### `ui/settings_dialog.py`
**Диалог настроек**

**Классы:**
- `SettingsDialog` - окно настроек с вкладками

**Ответственность:**
- Настройка горячих клавиш
- Управление типами событий
- Параметры записи и автосохранения

#### `ui/custom_event_dialog.py`
**Диалоги управления событиями**

**Классы:**
- `CustomEventDialog` - диалог добавления/редактирования событий
- `CustomEventManagerDialog` - основной диалог управления событиями

**Ответственность:**
- Создание и редактирование типов событий
- Назначение цветов и горячих клавиш
- Управление списком событий

#### `ui/drawing_overlay.py`
**Оверлей для рисования**

**Классы:**
- `DrawingTool` - enum инструментов рисования
- `DrawingItem` - элемент рисования
- `DrawingOverlay` - оверлей для рисования на видео

**Ответственность:**
- Рисование на кадрах видео
- Различные инструменты рисования
- Сохранение и загрузка аннотаций

#### Дополнительные UI компоненты

- `ui/event_list_model.py` - модель данных для списков событий
- `ui/event_card_delegate.py` - делегат для отрисовки карточек событий
- `ui/event_shortcut_list_widget.py` - виджет списка событий с горячими клавишами
- `ui/segment_list_widget.py` - виджет списка сегментов

### 3. Models Module (Модели данных)

#### `models/marker.py`
**Модель данных маркера**

**Классы:**
- `Marker` - dataclass для маркера события
- `EventType` - устаревший enum типов событий

**Ответственность:**
- Хранение данных о сегментах видео
- Сериализация/десериализация маркеров
- Обратная совместимость со старым форматом

### 4. Utils Module (Утилиты)

#### `utils/commands/` - Система команд Undo/Redo

**Файлы:**
- `undo_command.py` - базовый класс команд
- `marker_command.py` - базовый класс команд маркеров
- `add_marker_command.py` - команда добавления маркера
- `delete_marker_command.py` - команда удаления маркера
- `modify_marker_command.py` - команда изменения маркера
- `clear_markers_command.py` - команда очистки маркеров
- `undo_redo_manager.py` - менеджер undo/redo операций

**Ответственность:**
- Реализация паттерна Command для отмены операций
- Управление историей команд
- Поддержка сложных операций с маркерами

#### `utils/custom_events/` - Управление типами событий

**Файлы:**
- `custom_event_type.py` - модель типа события
- `custom_event_manager.py` - менеджер типов событий

**Ответственность:**
- Управление пользовательскими типами событий
- Сохранение настроек в QSettings
- Локализация названий событий

#### `utils/settings_manager.py`
**Менеджер настроек**

**Классы:**
- `SettingsManager` - управление настройками приложения

**Ответственность:**
- Сохранение/загрузка настроек через QSettings
- Управление настройками событий, горячих клавиш, автосохранения

#### `utils/shortcut_manager.py`
**Менеджер горячих клавиш**

**Классы:**
- `ShortcutManager` - управление глобальными горячими клавишами

**Ответственность:**
- Регистрация и разрегистрация горячих клавиш
- Предотвращение конфликтов клавиш

#### `utils/style_manager.py`
**Менеджер стилей**

**Классы:**
- `StyleManager` - глобальная система стилизации

**Ответственность:**
- Управление темами и стилями приложения
- Кеширование стилей для производительности

#### `utils/autosave.py`
**Автосохранение**

**Классы:**
- `AutosaveManager` - менеджер автосохранения

**Ответственность:**
- Периодическое автосохранение проекта
- Восстановление после сбоев

#### `utils/time_utils.py`
**Утилиты времени**

**Ответственность:**
- Форматирование времени и длительности
- Конвертация между форматами

## Архитектурные паттерны

### MVC Pattern (Model-View-Controller)
- **Models**: `Marker`, `CustomEventType`, `Project`
- **Views**: Все классы в `ui/` модуле
- **Controllers**: `VideoController`, `EventCreationController`

### Observer Pattern
- Сигнальная система Qt для коммуникации между компонентами
- `events_changed`, `markers_changed`, `playback_time_changed` сигналы

### Command Pattern
- Undo/Redo система в `utils/commands/`
- Каждая операция инкапсулирована в класс команды

### Singleton Pattern
- `CustomEventManager`, `SettingsManager`, `StyleManager`

### Factory Pattern
- Создание различных типов команд через соответствующие классы

## Поток данных

```
Пользовательский ввод (горячие клавиши, UI)
    ↓
MainWindow → VideoController
    ↓
EventCreationController → Marker creation
    ↓
CustomEventManager → Event type validation
    ↓
SettingsManager → Persistence
    ↓
UI обновление через сигналы
```

## Зависимости

### Основные библиотеки
- **PySide6** (>=6.6.0) - Qt bindings для Python
- **opencv-python** (>=4.8.0) - обработка видео
- **numpy** (>=1.24.0) - работа с массивами
- **moviepy** (>=1.0.0) - экспорт видео
- **pyinstaller** (>=6.0.0) - сборка исполняемого файла

### Системные зависимости
- FFmpeg (для обработки видео)
- Qt6 (через PySide6)

## Тестирование

Проект включает обширный набор тестов:
- `test_*.py` файлы в корневой директории
- Тесты для основных компонентов
- Интеграционные тесты экспорта
- Тесты UI компонентов

## Сборка и развертывание

- `setup.py` - скрипт установки
- `hockey_editor.spec` - конфигурация PyInstaller
- `BUILD_README.md` - инструкции по сборке

## Документация

- `docs/` - дополнительная документация
- `README.md` - основное описание проекта
- UML диаграммы в `docs/uml/`
- Техническая спецификация в `docs/ТЗ.docx`

## Будущие улучшения

### Архитектурные улучшения
1. **Микросервисная архитектура** - разделение на отдельные сервисы
2. **Плагинная система** - для расширения функциональности
3. **REST API** - для интеграции с внешними системами
4. **База данных** - для хранения больших объемов данных

### Технические улучшения
1. **Многопоточная обработка** - для тяжелых операций
2. **Кеширование кадров** - для плавного воспроизведения
3. **GPU ускорение** - для обработки видео
4. **Облачное хранение** - для проектов

### UX/UI улучшения
1. **Темная тема** - полная поддержка
2. **Многоязычность** - i18n поддержка
3. **Адаптивный интерфейс** - поддержка разных разрешений
4. **Клавиатурные сокращения** - расширенная система

---

*Документация создана на основе анализа исходного кода проекта Hockey Editor v2.0.0*
