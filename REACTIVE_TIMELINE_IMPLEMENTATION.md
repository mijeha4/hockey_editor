# Реализация динамического обновления таймлайна

## Обзор

Реализована система динамического перерисовывания таймлайна после изменений в редакторе с соблюдением строгой MVC архитектуры.

## Архитектура

### Модель (Model)

#### ObservableMarker
Реактивная модель маркера с сигналами изменений:
- `start_frame_changed` - изменение начального кадра
- `end_frame_changed` - изменение конечного кадра  
- `event_name_changed` - изменение типа события
- `note_changed` - изменение заметки
- `marker_changed` - общее изменение маркера

#### ObservableMarkerList
Реактивный список маркеров:
- `markers_changed` - изменение списка
- `marker_added` - добавление маркера
- `marker_removed` - удаление маркера
- `marker_modified` - изменение маркера

#### ObservableProject
Реактивная модель проекта:
- Автоматическое извещение об изменениях маркеров
- Синхронизация с обычной моделью Project для совместимости

### Контроллер (Controller)

#### TimelineController
Расширен для поддержки реактивных моделей:
- `set_observable_project()` - установка реактивного проекта
- Автоматическое подключение сигналов изменений
- Реактивные методы для работы с ObservableMarker

#### InstanceEditController  
Расширен для редактирования ObservableMarker:
- `set_observable_marker()` - установка реактивного маркера
- Реактивные методы навигации и редактирования
- Автоматическое обновление UI при изменениях

### Представление (View)

#### TimelineWidget
Реактивное представление таймлайна:
- `set_observable_segments()` - установка реактивных маркеров
- `update_segment()` - обновление конкретного сегмента
- `draw_playhead()` - динамическое обновление позиции воспроизведения

## Принципы работы

### 1. Реактивность
Изменения в модели автоматически извещают контроллер, который обновляет представление:

```
ObservableMarker → TimelineController → TimelineWidget
```

### 2. Оптимизация
- Обновление только измененных элементов
- Минимальная перерисовка при изменениях свойств
- Эффективное управление памятью

### 3. Совместимость
- Полная обратная совместимость с существующим кодом
- Автоматическая конвертация между Observable и обычными моделями
- Постепенное внедрение без нарушения текущей архитектуры

## Использование

### Базовое использование
```python
# Создание реактивного проекта
observable_project = ObservableProject("My Project")

# Добавление маркера
marker = ObservableMarker(100, 200, "Attack", "Test attack")
observable_project.add_marker(marker)

# Подключение к контроллеру
timeline_controller.set_observable_project(observable_project)
```

### Редактирование маркера
```python
# Изменение свойств маркера
marker.start_frame = 150  # Автоматически обновит таймлайн
marker.event_name = "Defense"

# Изменение через контроллер
timeline_controller.modify_observable_marker(0, 200, 300, "NewEvent", "New note")
```

### Интеграция с InstanceEditWindow
```python
# Установка реактивного маркера в редактор
instance_controller.set_observable_marker(observable_marker)

# Изменения в редакторе автоматически отображаются на таймлайне
instance_controller.nudge_observable_in_point(10)  # Сдвиг IN точки
```

## Преимущества

1. **Строгое соответствие MVC** - Четкое разделение ответственности
2. **Автоматическое обновление** - Изменения в редакторе сразу видны на таймлайне
3. **Производительность** - Только измененные элементы перерисовываются
4. **Расширяемость** - Легко добавлять новые View, синхронизированные с Model
5. **Снижение связанности** - Компоненты не зависят друг от друга напрямую

## Тестирование

Для тестирования системы используется `test_reactive_timeline.py`:

```bash
python test_reactive_timeline.py
```

Тест позволяет:
- Добавлять маркеры
- Изменять свойства маркеров
- Удалять маркеры
- Наблюдать за динамическим обновлением таймлайна

## Файлы реализации

- `src/models/domain/observable_marker.py` - Реактивные модели данных
- `src/models/domain/observable_project.py` - Реактивная модель проекта
- `src/controllers/timeline_controller.py` - Реактивный контроллер таймлайна
- `src/controllers/instance_edit_controller.py` - Реактивный контроллер редактирования
- `src/views/widgets/timeline.py` - Реактивное представление таймлайна
- `test_reactive_timeline.py` - Тестовый скрипт

## Будущие улучшения

1. **Анимации** - Плавные переходы при изменении сегментов
2. **Группировка** - Объединение близких маркеров
3. **Фильтрация** - Реактивная фильтрация по типам событий
4. **Множественный выбор** - Редактирование нескольких маркеров одновременно